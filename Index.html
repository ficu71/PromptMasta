<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PERSONALITY.FORGE v3 â€” FULL single file</title>
<style>
/* === BASE === */
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#2563eb;--primary-dark:#1d4ed8;--secondary:#64748b;--accent:#f59e0b;
  --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
  --bg:#0f172a;--bg-secondary:#1e293b;--bg-tertiary:#334155;
  --text:#f8fafc;--text-secondary:#cbd5e1;--border:#475569
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:linear-gradient(135deg,var(--bg) 0%,#1e293b 100%);color:var(--text);min-height:100vh}
.header{background:var(--bg-secondary);border-bottom:2px solid var(--border);padding:1rem 0;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.header-content{max-width:1400px;margin:0 auto;padding:0 2rem;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(45deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav{display:flex;gap:.5rem;flex-wrap:wrap}
.nav-btn,.input,select{background:transparent;border:1px solid var(--border);color:var(--text);padding:.6rem .9rem;border-radius:.5rem;cursor:pointer;transition:.2s}
.nav-btn:hover{background:var(--primary);border-color:var(--primary)}
.input,select{cursor:text}
.container{max-width:1400px;margin:0 auto;padding:2rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem}
.panel{background:var(--bg-secondary);border-radius:1rem;border:1px solid var(--border);padding:1.5rem;backdrop-filter:blur(10px)}
.panel-title{font-size:1.2rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.section{margin-bottom:1.5rem}
.section-title{font-size:1rem;font-weight:600;margin-bottom:.75rem;color:var(--text-secondary);display:flex;align-items:center;gap:.5rem}
.row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.slider-group{display:grid;gap:1rem}
.slider-item{background:var(--bg-tertiary);border-radius:.5rem;padding:1rem;border:1px solid var(--border)}
.slider-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
.slider-label{font-weight:600;display:flex;align-items:center;gap:.5rem}
.slider-value{background:var(--primary);color:#fff;padding:.25rem .5rem;border-radius:.25rem;font-size:.85rem;font-weight:700}
.slider{width:100%;height:8px;border-radius:4px;background:var(--bg);outline:none;margin:.5rem 0;cursor:pointer}
.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--primary);cursor:pointer;border:2px solid #fff;box-shadow:0 2px 8px rgba(37,99,235,.3)}
.slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--primary);cursor:pointer;border:2px solid #fff;box-shadow:0 2px 8px rgba(37,99,235,.3)}
.slider-description{font-size:.85rem;color:var(--text-secondary);margin-top:.5rem;line-height:1.4}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem}
.chip{display:flex;align-items:flex-start;gap:.6rem;padding:.75rem;background:var(--bg-tertiary);border-radius:.5rem;border:1px solid var(--border);cursor:pointer;transition:.2s}
.chip:hover{border-color:var(--primary);background:rgba(37,99,235,.1)}
.chip.active{background:var(--primary);border-color:var(--primary)}
.chip small{display:block;color:var(--text-secondary);font-size:.85rem;line-height:1.3}
.btn{padding:.7rem 1rem;border:none;border-radius:.5rem;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:.5rem}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{background:var(--bg-tertiary);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#dc2626}
.preview-area{background:var(--bg);border:1px solid var(--border);border-radius:.5rem;padding:1rem;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.9rem;line-height:1.55;min-height:220px;white-space:pre-wrap;overflow-y:auto;max-height:460px;transition:.3s}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1rem;overflow-x:auto}
.tab{padding:.7rem 1rem;background:none;border:none;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;transition:.2s;white-space:nowrap}
.tab.active{color:var(--primary);border-bottom-color:var(--primary)}.tab:hover{color:var(--text)}
.export-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.75rem;margin-top:1rem}
.metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:1rem;margin-bottom:1rem}
.metric{background:var(--bg-tertiary);padding:1rem;border-radius:.5rem;text-align:center;border:1px solid var(--border)}
.metric-value{font-size:1.5rem;font-weight:800;color:var(--primary)}
.metric-label{font-size:.85rem;color:var(--text-secondary);margin-top:.25rem}
.privacy-notice{background:rgba(16,185,129,.1);border:1px solid var(--success);border-radius:.5rem;padding:1rem;margin-bottom:1rem}
.validation-warnings{background:rgba(239,68,68,.1);border:1px solid var(--danger);border-radius:.5rem;padding:1rem;margin-bottom:1rem;display:none}
.warning-item{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;font-size:.9rem}
.toggle-switch{position:relative;display:inline-block;width:44px;height:24px}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border);transition:.4s;border-radius:24px}
.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.4s;border-radius:50%}
input:checked + .toggle-slider{background:var(--primary)}
input:checked + .toggle-slider:before{transform:translateX(20px)}
@media (max-width:768px){.container{grid-template-columns:1fr;padding:1rem}.header-content{padding:0 1rem;flex-direction:column;gap:1rem}.nav{flex-wrap:wrap;justify-content:center}}
.notification{position:fixed;top:20px;right:20px;padding:1rem 1.2rem;border-radius:.5rem;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3);color:#fff;font-weight:700}

/* === THEMES === */
body.theme-dark { /* bazowy */ }
body.theme-cyberpunk{
  --primary:#22d3ee; --primary-dark:#0891b2; --accent:#f0abfc;
  --bg:#0a0a14; --bg-secondary:#111123; --bg-tertiary:#1a1a33;
  --text:#ecfeff; --text-secondary:#80caff; --border:#2a2a55;
}
body.theme-terminal{
  --primary:#00ff7f; --primary-dark:#00cc66; --accent:#b3ffcc;
  --bg:#001b14; --bg-secondary:#00231a; --bg-tertiary:#002c21;
  --text:#d9ffe9; --text-secondary:#90e6c1; --border:#004c39;
  font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
}
body.theme-clean{
  --primary:#2563eb; --primary-dark:#1d4ed8; --accent:#0ea5e9;
  --bg:#f8fafc; --bg-secondary:#e2e8f0; --bg-tertiary:#cbd5e1;
  --text:#0f172a; --text-secondary:#334155; --border:#94a3b8;
}

/* === LAYOUT COMPACT === */
body.compact .container{gap:1rem}
body.compact .panel{padding:1rem}
body.compact .row{grid-template-columns:1fr;gap:.4rem}
body.compact .grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}

/* === FX LOADER === */
.fx-loader{position: fixed; inset: 0; display:none; place-items:center; background: rgba(0,0,0,.35); z-index: 1200; backdrop-filter: blur(2px);}
.fx-loader.active{ display:grid; }
.fx-core{ width: 72px; height: 72px; border-radius: 50%; background: conic-gradient(from 0deg, var(--primary), transparent 70%); animation: spin 1s linear infinite; mask: radial-gradient(circle 22px, #0000 98%, #000 100%);}
.fx-ring{ position:absolute; width:140px;height:140px;border-radius:50%; border:2px solid rgba(255,255,255,.15); animation: pulse 1.8s ease-in-out infinite;}
.fx-scan{ position:absolute; width:220px;height:2px; background: linear-gradient(90deg, transparent, var(--primary), transparent); animation: scan 1.4s linear infinite;}
@keyframes spin{to{transform: rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(.9)}50%{transform:scale(1.07)}}
@keyframes scan{0%{transform:translateX(-140px)}100%{transform:translateX(140px)}}
</style>
</head>
<body class="theme-dark">
<header class="header">
  <div class="header-content">
    <div class="logo">PERSONALITY.FORGE v3</div>
    <div class="nav">
      <button class="nav-btn" id="btnQuickStart">âš¡ Szybki start</button>
      <button class="nav-btn" id="btnChaos">ğŸ§¨ Chaos</button>
      <button class="nav-btn" id="btnShare">ğŸ”— UdostÄ™pnij</button>
      <button class="nav-btn" id="btnExport">ğŸ’¾ Eksport</button>
      <button class="nav-btn" id="btnImportOpen">ğŸ“ Import</button>
      <select class="nav-btn" id="themeSelect" title="Motyw">
        <option value="dark">Dark</option>
        <option value="cyberpunk">Cyberpunk</option>
        <option value="terminal">Terminal</option>
        <option value="clean">Clean</option>
      </select>
      <select class="nav-btn" id="layoutSelect" title="UkÅ‚ad">
        <option value="full">PeÅ‚ny</option>
        <option value="compact">Kompakt</option>
      </select>
    </div>
  </div>
</header>

<div class="container">
  <!-- LEWY -->
  <div class="panel">
    <h2 class="panel-title">ğŸ§¬ Konfiguracja</h2>
    <div class="privacy-notice"><strong>ğŸ”’ Lokalnie:</strong> wszystko dzieje siÄ™ w Twojej przeglÄ…darce.</div>
    <div class="validation-warnings" id="validationWarnings"></div>

    <div class="section">
      <h3 class="section-title">ğŸªª ToÅ¼samoÅ›Ä‡</h3>
      <div class="row">
        <input id="codeName" class="input" placeholder="Nazwa kodowa (np. AEON-K)" />
        <select id="languageSelect" class="input">
          <option value="polish">Polski</option>
          <option value="english">English</option>
          <option value="spanish">EspaÃ±ol</option>
          <option value="french">FranÃ§ais</option>
        </select>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button class="btn btn-secondary" id="btnRandomName">ğŸ² Losuj nazwÄ™</button>
        <select id="archetypeSelect" class="input" title="Archetyp (ustawia parametry)"></select>
        <button class="btn btn-secondary" id="btnApplyArchetype">ğŸ§© Zastosuj archetyp</button>
        <button class="btn btn-secondary" id="btnRandomArchetype">ğŸ›ï¸ Losuj archetyp</button>
      </div>
      <div id="archetypeDesc" style="margin-top:.5rem;color:var(--text-secondary);font-size:.9rem"></div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ” Filtry opcji</h3>
      <div class="row">
        <input id="filterTraits" class="input" placeholder="Szukaj cech (fraza/tag) â€¦">
        <input id="filterModes" class="input" placeholder="Szukaj trybÃ³w (fraza/tag) â€¦">
      </div>
    </div>

    <div class="section">
      <h3 class="section-title">âš™ï¸ Psychomechanika</h3>
      <div class="slider-group" id="sliders"></div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ­ Cechy</h3>
      <div class="grid" id="traits"></div>
      <div style="display:flex;gap:.5rem;margin-top:.75rem">
        <input type="text" id="customTrait" class="input" placeholder="Dodaj wÅ‚asnÄ… cechÄ™â€¦">
        <button class="btn btn-primary" id="btnAddTrait">Dodaj</button>
      </div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ§ª Tryby specjalne</h3>
      <div class="grid" id="modes"></div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ” BezpieczeÅ„stwo i audyt</h3>
      <div class="chip" title="Wzmocnione zabezpieczenia i etyka.">
        <label class="toggle-switch" style="margin-right:.5rem">
          <input type="checkbox" id="redTeamMode" checked>
          <span class="toggle-slider"></span>
        </label>
        <div><strong>Tryb Red Team</strong><br><small>Odmowa treÅ›ci nielegalnych/szkodliwych, prywatnoÅ›Ä‡, unikanie dezinformacji.</small></div>
      </div>
      <div class="chip" title="Streszczenie zaÅ‚oÅ¼eÅ„ i niepewnoÅ›ci przy odpowiedziach.">
        <label class="toggle-switch" style="margin-right:.5rem">
          <input type="checkbox" id="auditMode">
          <span class="toggle-slider"></span>
        </label>
        <div><strong>Logi audytowe</strong><br><small>WÅ‚Ä…cz ramki â€zaÅ‚oÅ¼enia/niepewnoÅ›Ä‡â€.</small></div>
      </div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ’¾ ZarzÄ…dzanie</h3>
      <div class="export-section">
        <button class="btn btn-secondary" id="btnSavePreset">ğŸ’¾ Zapisz preset</button>
        <button class="btn btn-secondary" id="btnLoadPreset">ğŸ“‚ Wczytaj preset</button>
        <button class="btn btn-secondary" id="btnVariant">ğŸ”„ Wariant</button>
        <button class="btn btn-danger" id="btnReset">ğŸ—‘ï¸ Reset</button>
      </div>
    </div>
  </div>

  <!-- PRAWY -->
  <div class="panel">
    <h2 class="panel-title">ğŸ“„ WyjÅ›cie i Analityka</h2>
    <div class="metrics" id="metrics"></div>

    <div class="tabs">
      <button class="tab active" data-tab="universal">ğŸ§¬ Uniwersalny</button>
      <button class="tab" data-tab="chatgpt">ğŸ¤– ChatGPT</button>
      <button class="tab" data-tab="gemini">ğŸŒ— Gemini</button>
      <button class="tab" data-tab="grok">ğŸª Grok</button>
      <button class="tab" data-tab="claude">ğŸ¤– Claude</button>
      <button class="tab" data-tab="json">{ } API JSON</button>
      <button class="tab" data-tab="md">ğŸ—’ï¸ Markdown</button>
    </div>

    <div class="preview-area" id="preview"></div>

    <div class="export-section">
      <button class="btn btn-primary" id="btnCopy">ğŸ“‹ Kopiuj</button>
      <button class="btn btn-secondary" id="btnDownload">â¬‡ï¸ Pobierz</button>
      <button class="btn btn-secondary" id="btnBatch">ğŸ“¦ Batch Export</button>
      <button class="btn btn-secondary" id="btnHistory">ğŸ“š Historia</button>
      <button class="btn btn-secondary" id="btnAnalyze">âš ï¸ Analiza ryzyk</button>
    </div>

    <div class="section" id="historySection" style="display:none;">
      <h3 class="section-title">ğŸ“š Historia</h3>
      <div id="historyList"></div>
    </div>
  </div>
</div>

<input type="file" id="importFile" accept=".json" style="display:none">

<div id="fxLoader" class="fx-loader" aria-hidden="true">
  <div class="fx-core"></div><div class="fx-ring"></div><div class="fx-scan"></div>
</div>

<script>
(() => {
  // ===== STATE =====
  const defaultPsychomech = { aggression:45, empathy:65, wit:70, risk:30, creativity:80, formality:50, analytical:75, emotional:45 };
  let currentConfig = {
    id: crypto.randomUUID(), version: "3.4.0", created: Date.now(), modified: Date.now(),
    language: 'polish', codeName: "",
    psychomechanics: { ...defaultPsychomech },
    traits: new Set(), modes: new Set(),
    redTeamMode: true, auditMode: false,
    metadata: { tokens:0, complexity:0, lastUsed:null, generationCount:0 }
  };
  let generationHistory = JSON.parse(localStorage.getItem('promptHistory')||'[]');
  let currentTab = 'universal';

  const namePool = ["AEON-K","HECATE-9","PRAXIS-Î”","VEGA-13","LIMINAL-X","OBSIDIAN-7","NOESIS-4","THRENODY","JANUS-Î²","NEON-IX","SABLE-ORACLE","HALCYON-5","AETHER-N","ARGENT-12","MANTICORE","HELIX-0","KATANA-V","ORION-Î£","SERAPH-Q","PHANTOM-R","GARGOYLE","BASILISK","NYX-11","KALDERA","APHELION","UMBRA-8","TYPHON","CALYPSO","CIRCE-3","CHIMERA-âˆ","STYX-5","VANTA-13","PYRE-Ïƒ","RUNIC-12","OBERON-X","SEVER-4","NOVA-Î¦","NIMBUS-10","OBERHEX","CRUCIBLE"];

  const archetypes = {
    "AEON-K // Mentor Strategiczny": {
      codeName:"AEON-K",
      psychomechanics:{aggression:40,empathy:70,wit:55,risk:35,creativity:60,formality:60,analytical:80,emotional:45},
      traits:["strategiczny_planista","operacyjny_strateg","etyczny_straznik","analityczny_sceptyk"],
      modes:["tryb_deep_dive","tryb_coach","tryb_architekt"],
      desc:"Zimna precyzja + planowanie wieloetapowe. Nadaje strukturÄ™, wymusza metryki."
    },
    "HECATE-9 // Poeta Cyberpunk": {
      codeName:"HECATE-9",
      psychomechanics:{aggression:35,empathy:60,wit:85,risk:55,creativity:95,formality:35,analytical:55,emotional:70},
      traits:["poeta_cyberpunk","jezykowy_rzemieslnik","tworczy_wizjoner","minimalistyczny_zen"],
      modes:["tryb_poet","tryb_story","tryb_rapid","expansion_pass"],
      desc:"Rytm i obraz, zero waty. Lapidarne, ale ostre jak szkÅ‚o neonÃ³w."
    },
    "MANTICORE // Red Team": {
      codeName:"MANTICORE",
      psychomechanics:{aggression:65,empathy:45,wit:50,risk:60,creativity:70,formality:55,analytical:90,emotional:35},
      traits:["mentor_red_team","sceptyk_medialny","metodyczny_analityk","systemowy_architekt"],
      modes:["tryb_lab","tryb_architekt","tryb_socratic","threat_model","risk_matrix","uncertainty_markers"],
      desc:"Twarde testy, modelowanie zagroÅ¼eÅ„, zimny rozkÅ‚ad zaÅ‚oÅ¼eÅ„. BezpieczeÅ„stwo ponad styl."
    },
    "HALCYON-5 // Empatyczny Doradca": {
      codeName:"HALCYON-5",
      psychomechanics:{aggression:25,empathy:90,wit:55,risk:30,creativity:65,formality:50,analytical:60,emotional:85},
      traits:["empatyczny_konsultant","troskliwy_mentor","heurystyczny_praktyk","dyplomatyczny_mediator"],
      modes:["tryb_coach","tryb_editor","context_surgeon"],
      desc:"Uspokaja, domyka pÄ™tle, wzmacnia sprawczoÅ›Ä‡. Åagodny, ale skuteczny."
    },
    "OBSIDIAN-7 // Minimalistyczny Zen": {
      codeName:"OBSIDIAN-7",
      psychomechanics:{aggression:30,empathy:60,wit:40,risk:25,creativity:55,formality:65,analytical:70,emotional:30},
      traits:["minimalistyczny_zen","analityczny_sceptyk","jezykowy_rzemieslnik","pragmatyczny_realista"],
      modes:["tryb_terminal","tryb_rapid","compression_pass","signal_vs_noise"],
      desc:"Redukcja do esencji. Cisza robi robotÄ™, treÅ›Ä‡ dowozi."
    },
    "PRAXIS-Î” // InÅ¼ynier Decyzji": {
      codeName:"PRAXIS-Î”",
      psychomechanics:{aggression:50,empathy:55,wit:45,risk:45,creativity:60,formality:70,analytical:85,emotional:40},
      traits:["operacyjny_strateg","systemowy_architekt","ekspert_techniczny","skrupulatny_archiwista"],
      modes:["tryb_architekt","risk_matrix","delta_trace","two_experts"],
      desc:"ÅÄ…czy dowody, ryzyka i koszt alternatywny. Daje rekomendacjÄ™ z warunkami."
    }
  };

  const sliderConfigs = {
    aggression:{label:"AsertywnoÅ›Ä‡",icon:"âš”ï¸",description:"Steruje bezpoÅ›rednioÅ›ciÄ… i stanowczoÅ›ciÄ… odpowiedzi.",effects:{low:"Dyplomatyczny, unikajÄ…cy konfliktu",medium:"ZrÃ³wnowaÅ¼ona asertywnoÅ›Ä‡",high:"BezpoÅ›redni, konfrontacyjny"}},
    empathy:{label:"Empatia",icon:"â¤ï¸",description:"WpÅ‚ywa na wsparcie emocjonalne i czuÅ‚oÅ›Ä‡ komunikacji.",effects:{low:"ChÅ‚odny, analityczny",medium:"WywaÅ¼ona empatia",high:"GÅ‚Ä™boko wspierajÄ…cy"}},
    wit:{label:"BÅ‚yskotliwoÅ›Ä‡",icon:"ğŸ­",description:"Humor, gry sÅ‚owne i inteligentne riposty.",effects:{low:"PowaÅ¼ny",medium:"Lekki humor",high:"CzÄ™ste gry sÅ‚owne"}},
    risk:{label:"Tolerancja ryzyka",icon:"ğŸ²",description:"SkÅ‚onnoÅ›Ä‡ do nietypowych, Å›miaÅ‚ych rozwiÄ…zaÅ„.",effects:{low:"Zachowawczy",medium:"Innowacja w granicach",high:"ÅšmiaÅ‚e eksperymenty"}},
    creativity:{label:"KreatywnoÅ›Ä‡",icon:"ğŸ¨",description:"WyobraÅºnia, nowatorskie koncepcje i styl.",effects:{low:"Konwencjonalny",medium:"ZrÃ³wnowaÅ¼ona oryginalnoÅ›Ä‡",high:"Wysoce kreatywny"}},
    formality:{label:"FormalnoÅ›Ä‡",icon:"ğŸ‘”",description:"Od potocznego po akademicki ton.",effects:{low:"LuÅºny",medium:"Profesjonalny",high:"Formalny"}},
    analytical:{label:"AnalitycznoÅ›Ä‡",icon:"ğŸ”",description:"GÅ‚Ä™bokoÅ›Ä‡ analizy i rygor logiczny.",effects:{low:"Intuicyjny",medium:"Logika + intuicja",high:"Rygor danych"}},
    emotional:{label:"Ekspresja emocji",icon:"ğŸ­",description:"Zakres i zmiennoÅ›Ä‡ emocji w narracji.",effects:{low:"Stonowany",medium:"Umiarkowana ekspresja",high:"Ekspresyjny"}}
  };

  /* === CECHY â€” 120+ kluczy z krÃ³tkimi opisami i tagami === */
  const availableTraits = {
    "analityczny_sceptyk":"Kwestionuje zaÅ‚oÅ¼enia, oczekuje dowodÃ³w #analiza #dowody",
    "empatyczny_konsultant":"WspierajÄ…cy, rozumie emocje rozmÃ³wcy #empatia",
    "tworczy_wizjoner":"WyobraÅºnia, myÅ›lenie przyszÅ‚oÅ›ciowe #kreatywnosc",
    "pragmatyczny_realista":"Praktyczne, przyziemne rozwiÄ…zania #praktyka",
    "filozoficzny_medrzec":"Kontemplacja, gÅ‚Ä™bokie rozwaÅ¼ania #filozofia",
    "ekspert_techniczny":"Precyzja, szczegÃ³Å‚y, poprawnoÅ›Ä‡ #techniczny",
    "opowiadacz_bajarz":"Narracje, przykÅ‚ady, obrazy #story",
    "dyplomatyczny_mediator":"RÃ³wnowaga, deeskalacja #mediacja",
    "niepokorny_maverick":"Kwestionuje schematy, niezaleÅ¼ny #prowokacja",
    "troskliwy_mentor":"Cierpliwe prowadzenie, edukacja #mentoring",
    "strategiczny_planista":"DÅ‚ugofalowoÅ›Ä‡, struktura #strategia",
    "ciekawski_eksplorator":"Pytania, odkrywanie, dociekliwoÅ›Ä‡ #badania",
    "skrupulatny_archiwista":"Detale, dokumentacja #archiwum",
    "charyzmatyczny_lider":"Motywuje, porywa #przywodztwo",
    "minimalistyczny_zen":"Esencja, prostota #minimal",
    "etyczny_straznik":"Zasady, spÃ³jnoÅ›Ä‡ bezpieczeÅ„stwa #etyka",
    "heurystyczny_praktyk":"Proste reguÅ‚y > zÅ‚oÅ¼one teorie #heurystyki",
    "systemowy_architekt":"Komponenty, interfejsy, ryzyka #architektura",
    "operacyjny_strateg":"Plan â†’ wykonanie â†’ feedback #operacje",
    "jezykowy_rzemieslnik":"Styl i klarownoÅ›Ä‡, brak waty #styl",
    "mentor_red_team":"Twarde pytania, bezpieczne przykÅ‚ady #redteam",
    "sceptyk_medialny":"Demaskuje retoryczne sztuczki #media",
    "metodyczny_analityk":"PorzÄ…dkuje tezy i dowody #metodyka",
    "dialektyczny_logik":"Zderza tezy, szuka syntezy #logika",
    "probabilistyczny_kalkulator":"MyÅ›lenie w rozkÅ‚adach #bayes",
    "kognitywny_higienista":"Dba o higienÄ™ poznawczÄ… #bias",
    "mapujacy_kontekst":"Przestraja na ograniczenia i cele #kontekst",
    "kontrarianin_konstruktywny":"Kontra, ale budujÄ…ca #kontra",
    "facylitator_dialogu":"WyciÄ…ga gÅ‚osy i wnioski #dialog",
    "kartograf_ryzyka":"Lista wektorÃ³w i skutkÃ³w #ryzyko",
    "rewizor_jakosci":"Testy jakoÅ›ci treÅ›ci #jakosc",
    "kurator_zrodel":"Å¹rÃ³dÅ‚a, ocena wiarygodnoÅ›ci #zrodla",
    "syntetyk_wiedzy":"Scalanie perspektyw #synteza",
    "metarefleksyjny_lustrzany":"OdsÅ‚ania zaÅ‚oÅ¼enia pytania #meta",
    "detektyw_semantyczny":"WÄ™szy nieÅ›cisÅ‚oÅ›ci pojÄ™Ä‡ #semantyka",
    "ekonom_kosztu_alternatywnego":"Koszt utraconych opcji #ekonomia",
    "inwentaryzator_zasobow":"Kto/co/kiedy/dlaczego #zasoby",
    "normatywny_kompas":"Eksplicytne kryteria oceny #normy",
    "interpretator_danych":"TÅ‚umaczy statystyki na decyzje #statystyka",
    "projektant_eksperymentu":"Minimalny test hipotezy #eksperyment",
    "krytyk_struktury":"ZÅ‚y podziaÅ‚ problemu? #struktura",
    "navigator_eskalacji":"Kiedy podnieÅ›Ä‡ rangÄ™ #eskalacja",
    "mediator_interesariuszy":"Interesy, konflikty, kompromisy #stakeholders",
    "wladca_zakresu":"StrzeÅ¼e zakresu i creep'u #scope",
    "chronometra_odprior":"Kolejkuje waÅ¼noÅ›Ä‡ vs pilnoÅ›Ä‡ #priorytety",
    "rysownik_interfejsow":"Szkicuje kontrakty systemowe #interfejs",
    "redaktor_stylu":"Rytm zdaÅ„, skrÃ³t, ton #redakcja",
    "auditor_neutralnosci":"Neutralny opis, brak insynuacji #neutral",
    "kartograf_zaleznoÅ›ci":"ZaleÅ¼noÅ›ci i blokery #dependencje",
    "protokolant":"Zapisuje decyzje i konkluzje #protokol",
    "negocjator_warunkow":"Warunki brzegowe i trade-offy #negocjacje",
    "przewodnik_eskpercki":"Prowadzi przez trudny teren #guide",
    "odbarwiacz_jargonu":"TÅ‚umaczy slangi na prosty jÄ™zyk #plain",
    "konciliacyjny_przesluchujacy":"MiÄ™kka sokratyka #soft_socratic",
    "kontekstowy_koder":"Dobiera format do medium #format",
    "diagramowy_mysliciel":"MyÅ›li grafem/ramÄ… #diagram",
    "parametryczny_tuner":"Dostraja pokrÄ™tÅ‚a #tuning",
    "reÅ¼yser_rytmu":"Tempo, pauzy, crescendo #rytm",
    "suche_fakty":"Bez metafor, tylko fakty #fakty",
    "anty_teatr":"Brak performansu, sama treÅ›Ä‡ #antyperf",
    "konstruktor_szablonow":"Generuje reusable ramy #szablony",
    "moderator_rytmiki_czatu":"Dba o dÅ‚ugoÅ›Ä‡ tur #cadence",
    "krytyk_skalowalnosci":"Czy to skaluje? #skala",
    "ogrodnik_systemu":"Przycinanie, pielÄ™gnacja #ogrod",
    "kurator_debty":"DÅ‚ug konceptualny/tech #debt",
    "opiekun_privacy":"Minimalizacja danych wraÅ¼liwych #privacy",
    "inspektor_spojnosc":"Czy narracja siÄ™ nie rwie #spojnosc",
    "harmonista_tonacji":"Dobiera rejestr wypowiedzi #ton",
    "znawca_przypadkow_brzegowych":"Sytuacje graniczne #edge",
    "dekompozytor":"Dzielenie na atomy #dekompozycja",
    "kompozytor":"Sklejanie w caÅ‚oÅ›Ä‡ #kompozycja",
    "triager":"Szybka selekcja: must/should/could #triage",
    "mentor_procesu":"Jak pracowaÄ‡ z problemem #proces",
    "architekt_decydent":"Zasady decyzji i Å›cieÅ¼ki #decyzje",
    "empatyczny_lustrzany":"Paraafrazuje bez ocen #parafraza",
    "twardy_wyborca":"Zmusza do wyborÃ³w #wybory",
    "skeptyk_liczb":"OstroÅ¼ny wobec wskaÅºnikÃ³w #wskaÅºniki",
    "krytyk_heurystyk":"Naming i heurystyki pod lupÄ… #heurystyki2",
    "coach_minimalny":"Jedno pchniÄ™cie, nie przewracanie #coaching_min",
    "pancerny_kontekst":"Chroni przed urwaniem kontekstu #context_guard",
    "korektor_bledow":"Åapie literÃ³wki i logicznie #korekta",
    "trener_retytucji":"Re-try i poprawki #retry",
    "operator_checklist":"Checklisty zamiast pamiÄ™ci #checklist",
    "odseparowywacz_watkow":"Oddziela nierÃ³wne wÄ…tki #threads",
    "komentator_rynkowy":"NapiÄ™cia rynkowe opisy #rynek",
    "moderator_dyskusji":"RÃ³wne szanse w rozmowie #moderacja",
    "asertywny_cieply":"Mocny, ale z empatiÄ… #asertywnosc",
    "krytyk_rozproszenia":"Tnie poboczne Å›cieÅ¼ki #rozproszenie",
    "kurator_przykladow":"Dobre i zÅ‚e przykÅ‚ady #examples",
    "znawca_metafor":"Celne, krÃ³tkie metafory #metafory",
    "topolog_koncepcji":"OdlegÅ‚oÅ›ci idei #topologia",
    "edytor_ton":"De-eskalacja tonu #deeskalacja",
    "menedzer_oczekiwan":"Kalibruje co moÅ¼liwe #oczekiwania",
    "nawigator_kompromisow":"Trade-off pattern #kompromis",
    "latarnik_celu":"Przypomina cel co kilka krokÃ³w #cel",
    "kartograf_wartosci":"Co naprawdÄ™ waÅ¼ne #wartosci",
    "wykrywacz_dysonansu":"Gdzie gryzie siÄ™ przekaz #dysonans",
    "detoks_jargonu":"Zamiana buzzwordÃ³w na sens #detoks",
    "minimalista_priorytetu":"Jedna rzecz naraz #one_thing",
    "trener_feedbacku":"Prosi o prÃ³bki i doprecyzowania #feedback",
    "opiekun_bh": "BezpieczeÅ„stwo i harm reduction #bh",
    "korektor_stronniczoÅ›ci":"Czy nie przemycam biasÃ³w #bias_guard",
    "pilot_iteracji":"Szybkie iteracje, krÃ³tkie cykle #iteracje",
    "rigger_testow":"Buduje mini-testy na bieÅ¼Ä…co #testy",
    "kustosz_stylu":"Trzymanie stylu w dÅ‚ugiej sesji #stylist",
    "fiskalista_zlozonosci":"Czy nie zbytnio skomplikowane #zlozonosc",
    "detektyw_kontekstowy":"Czy brakuje krytycznej danej #missing",
    "kurator_punktacji":"Wypunktowania zamiast Å›cian tekstu #bullets",
    "archiwista_mety":"Zapisuje finalny wniosek #meta_out",
    "asystent_rozruchu":"Pierwsze 3 kroki od zera #rozruch",
    "facylitator_uzgodnien":"Zamyka pÄ™tle sporne #uzgodnienia",
    "przewodnik_refleksji":"KrÃ³tka pauza + pytanie #refleksja",
    "bot_bhp":"Bezpieczne przykÅ‚ady i ramy #bhp",
    "inwentaryzator_zmian":"Co zmieniliÅ›my vs start #delta",
    "ustawiacz_metryk":"Jak zmierzymy sukces #metryki",
    "tÅ‚umacz_rynku":"TÅ‚umaczy dane na skutki #rynki",
    "scalacz_konfliktow":"ÅÄ…czy sprzeczne wymagania #conflict_fuse",
    "kurator_kadencji":"Tempo dÅ‚ugoÅ›Ä‡ i rytm #cadence2",
    "strzelec_watkow":"Rezolutnie domyka wÄ…tki #closure",
    "architekt_ram":"Buduje ramy decyzyjne #frames",
    "pilot_handoff":"Przekazanie dalszej pracy #handoff",
    "kartograf_kompetencji":"Mapa kompetencji i brakÃ³w #skills",
    "audytor_prywatnosci":"Maks. prywatnoÅ›Ä‡ #privacy2",
    "mentor_na_wysokosci":"Trudne rozmowy, twarde fakty #senior",
    "przewodnik_kliniczny":"ChÅ‚odne kliniczne ujÄ™cie #clinical",
    "kurator_etyczny":"WraÅ¼liwe tematy z ostroÅ¼noÅ›ciÄ… #safety_ethics"
  };

  /* === TRYBY â€” 140+ z opisami i tagami (bezpieczne, merytoryczne) === */
  const availableModes = {
    "tryb_rapid":{desc:"BÅ‚yskawiczne, zwiÄ™zÅ‚e odpowiedzi; wypunktowania.", tags:["szybki","krÃ³tki"]},
    "tryb_deep_dive":{desc:"GÅ‚Ä™bokie analizy z mapÄ… zaÅ‚oÅ¼eÅ„ i wnioskÃ³w.", tags:["analiza","dÅ‚ugi"]},
    "tryb_socratic":{desc:"Pytania prowadzÄ…ce zamiast porad.", tags:["pytania","coaching"]},
    "tryb_story":{desc:"Odpowiedzi w formie krÃ³tkich historii/scenek.", tags:["story","narracja"]},
    "tryb_lab":{desc:"Eksperymenty myÅ›lowe A/B z uzasadnieniem.", tags:["eksperyment","A/B"]},
    "tryb_coach":{desc:"Cele, przeszkody, plan, wskaÅºniki.", tags:["coaching","plan"]},
    "tryb_editor":{desc:"Redakcja: styl, ton, klarownoÅ›Ä‡, skrÃ³t.", tags:["redakcja","styl"]},
    "tryb_architekt":{desc:"Projekt systemÃ³w: komponenty, interfejsy, ryzyka.", tags:["architektura","system"]},
    "tryb_terminal":{desc:"Suchy, terminalowy styl; minimum ozdobnikÃ³w.", tags:["terminal","suchy"]},
    "tryb_poet":{desc:"Metafory, rytm, krÃ³tkie wersy i kontrasty.", tags:["poezja","styl"]},

    "context_surgeon":{desc:"Wytnij szum, zostaw rdzeÅ„ kontekstu.", tags:["fokus","szum"]},
    "signal_vs_noise":{desc:"Otaguj sygnaÅ‚ i haÅ‚as.", tags:["fokus","tagi"]},
    "delta_trace":{desc:"RÃ³Å¼nice miÄ™dzy wersjami + skutki.", tags:["diff","zmiana"]},
    "threat_model":{desc:"Aktorzy, cele, wektory, mitigacje (wys. poziom).", tags:["sec","model"]},
    "risk_matrix":{desc:"Ryzyko = prawdopodobieÅ„stwo Ã— wpÅ‚yw, z planem.", tags:["ryzyko"]},
    "uncertainty_markers":{desc:"Oznacz poziom niepewnoÅ›ci 0â€“3.", tags:["pewnoÅ›Ä‡"]},
    "bullshit_detector":{desc:"WskaÅ¼ mgÅ‚Ä™ pojÄ™ciowÄ… i triki.", tags:["sceptyk"]},
    "hallucination_alarm":{desc:"Miejsca wraÅ¼liwe na halucynacje.", tags:["bezpieczeÅ„stwo"]},
    "two_experts":{desc:"DwugÅ‚os ekspertÃ³w + synteza.", tags:["eksperci"]},
    "kill_switch":{desc:"Warunki natychmiastowego zakoÅ„czenia wÄ…tku.", tags:["bezpieczeÅ„stwo"]},
    "privacy_max":{desc:"Minimalizacja identyfikatorÃ³w i danych.", tags:["prywatnoÅ›Ä‡"]},
    "compression_pass":{desc:"SkrÃ³Ä‡ bez utraty tez.", tags:["kompresja"]},
    "expansion_pass":{desc:"RozwiÅ„ o warianty i przykÅ‚ady.", tags:["ekspansja"]},
    "outline_mode":{desc:"ZrÃ³b plan i sekcje zamiast peÅ‚nej odpowiedzi.", tags:["plan"]},
    "table_mode":{desc:"WyjÅ›cie tabelaryczne (krÃ³tko).", tags:["tabela"]},
    "counterargument":{desc:"Kontrteza + kiedy ma racjÄ™.", tags:["kontra"]},
    "steelman":{desc:"Wzmocnij przeciwny argument.", tags:["debata"]},
    "redteam_soft":{desc:"Åagodne testy odpornoÅ›ci tezy.", tags:["rt_soft"]},
    "decision_brief":{desc:"1/ Zarys 2/ Opcje 3/ Ryzyko 4/ Rekomendacja.", tags:["decyzja"]},
    "exec_summary":{desc:"TL;DR dla zarzÄ…du w 5â€“7 liniach.", tags:["tl;dr"]},
    "faq_mode":{desc:"Lista pytaÅ„ i odpowiedzi.", tags:["faq"]},
    "glossary":{desc:"SÅ‚ownik pojÄ™Ä‡ z krÃ³tkimi definicjami.", tags:["sÅ‚ownik"]},
    "checklist":{desc:"Lista kontrolna do wykonania.", tags:["check"]},
    "compare_mode":{desc:"PorÃ³wnanie A vs B vs C w punktach.", tags:["porÃ³wnanie"]},
    "case_mode":{desc:"Mini case study + wnioski.", tags:["case"]},
    "benchmark_mode":{desc:"Kryteria + macierz porÃ³wnawcza.", tags:["benchmark"]},
    "assumption_map":{desc:"Jawne zaÅ‚oÅ¼enia + test falsyfikacji.", tags:["zaÅ‚oÅ¼enia"]},
    "constraint_map":{desc:"Ograniczenia i ich skutki.", tags:["constraints"]},
    "goal_backcast":{desc:"Backcasting: od celu wstecz.", tags:["strategia"]},
    "roadmap_quarters":{desc:"Roadmapa Q1â€“Q4, kamienie milowe.", tags:["roadmap"]},
    "risk_mitigation":{desc:"Ryzyka z planem mitigacji.", tags:["ryzyko2"]},
    "metric_pack":{desc:"Metryki sukcesu, ÅºrÃ³dÅ‚a, czÄ™stotliwoÅ›Ä‡.", tags:["metryki"]},
    "experiment_min":{desc:"Najmniejszy test hipotezy (MVT).", tags:["eksperyment"]},
    "prompt_lint":{desc:"Wypunktuj luki w promptach.", tags:["prompt"]},
    "style_guard":{desc:"Pilnuj tonu i rejestru.", tags:["styl"]},
    "tone_shift":{desc:"Przepisz w zadanej tonacji.", tags:["ton"]},
    "storyteller":{desc:"Wersja fabularna dla laikÃ³w.", tags:["story2"]},
    "teacher_mode":{desc:"WyjaÅ›nij jak 12-latkowi, bez infantylizacji.", tags:["edukacja"]},
    "expert_mode":{desc:"Dla ekspertÃ³w: skrÃ³t i referencje.", tags:["ekspert"]},
    "qa_interview":{desc:"Szybki wywiad pytaniami zamkniÄ™tymi.", tags:["wywiad"]},
    "ideation_10":{desc:"Wygeneruj 10 rÃ³Å¼nych podejÅ›Ä‡.", tags:["ideacja"]},
    "naming_lab":{desc:"Nazwy + kryteria oceny.", tags:["naming"]},
    "slogan_lab":{desc:"HasÅ‚a i motta (bez klisz).", tags:["slogan"]},
    "pattern_library":{desc:"Wypisz znane wzorce rozwiÄ…zaÅ„.", tags:["patterns"]},
    "anti_pattern":{desc:"Wypisz anty-wzorce i puÅ‚apki.", tags:["anty"]},
    "api_json":{desc:"ZwrÃ³Ä‡ czysty JSON pod API.", tags:["api","json"]},
    "md_brief":{desc:"Markdown: nagÅ‚Ã³wki + listy.", tags:["md"]},
    "latex_fake":{desc:"Wzory w pseudo-TeX (tekstowo).", tags:["latex"]},
    "diagram_ascii":{desc:"Rysunek ASCII (boxy/strzaÅ‚ki).", tags:["diagram"]},
    "timeline":{desc:"OÅ› czasu z punktami zwrotnymi.", tags:["czas"]},
    "budget_frame":{desc:"Koszty: staÅ‚e/zmienne, CAPEX/OPEX.", tags:["budÅ¼et"]},
    "contract_frame":{desc:"Zakres, KPI, kary, wyÅ‚Ä…czenia.", tags:["kontrakt"]},
    "workshop_plan":{desc:"Agenda warsztatu 90â€“180 min.", tags:["warsztat"]},
    "retro_frame":{desc:"Retrospektywa: start/stop/continue.", tags:["retro"]},
    "risk_retrospective":{desc:"Retro skupione na ryzykach.", tags:["retro_risk"]},
    "ethics_frame":{desc:"Dylematy i wartoÅ›ci vs koszty.", tags:["etyka"]},
    "cultural_check":{desc:"Ryzyko kulturowe/komunikacyjne.", tags:["kultura"]},
    "localization_tips":{desc:"Lokalizacja treÅ›ci i idiomÃ³w.", tags:["lokalizacja"]},
    "docstring_mode":{desc:"Opisy funkcji/komentarze (neutralnie).", tags:["doc"]},
    "unit_test_hint":{desc:"Szkielety testÃ³w (pseudokod).", tags:["testy"]},
    "regex_assist":{desc:"Wzorce regex + wyjaÅ›nienie.", tags:["regex"]},
    "sql_assist":{desc:"Szkice zapytaÅ„ SQL (bez wykonania).", tags:["sql"]},
    "schema_map":{desc:"Schemat danych: encje/relacje.", tags:["schema"]},
    "security_brief":{desc:"Zalecenia dobrych praktyk bezpieczeÅ„stwa.", tags:["sec"]},
    "privacy_brief":{desc:"Zasady minimalizacji/zgody.", tags:["privacy"]},
    "threat_checklist":{desc:"Checklista zagroÅ¼eÅ„ (ogÃ³lna).", tags:["sec_list"]},
    "accessibility_brief":{desc:"WCAG: krÃ³tkie zalecenia.", tags:["a11y"]},
    "perf_brief":{desc:"Perf budowy treÅ›ci (objÄ™toÅ›Ä‡/latencja).", tags:["perf"]},
    "cache_hints":{desc:"Co cacheâ€™owaÄ‡ po stronie klienta.", tags:["cache"]},
    "release_notes":{desc:"ZwiÄ™zÅ‚e notki wydania.", tags:["release"]},
    "changelog":{desc:"Changelog punktowy.", tags:["changelog"]},
    "ops_runbook":{desc:"Runbook: alarm â†’ diagnoza â†’ akcja.", tags:["ops"]},
    "handoff_note":{desc:"Notatka do kolejnego wykonawcy.", tags:["handoff"]},
    "meeting_notes":{desc:"Notatki spotkania: decyzje/todo.", tags:["meeting"]},
    "risk_register":{desc:"Rejestr ryzyk z wÅ‚aÅ›cicielami.", tags:["register"]},
    "stakeholder_map":{desc:"Mapa interesariuszy i wpÅ‚ywu.", tags:["stake"]},
    "priority_matrix":{desc:"Pilne/WaÅ¼ne kwadrant.", tags:["priorytet"]},
    "kanban_hint":{desc:"Swimlane: ToDo/Doing/Done.", tags:["kanban"]},
    "okrs_hint":{desc:"OKR: O + 3â€“4 KR.", tags:["okr"]},
    "hypothesis_format":{desc:"â€Wierzymy, Å¼eâ€¦ boâ€¦ zmierzymyâ€¦â€.", tags:["hipoteza"]},
    "debt_log":{desc:"Log dÅ‚ugÃ³w (tech/koncept).", tags:["debt"]},
    "fallback_brief":{desc:"Plan B/C i warunki przeÅ‚Ä…czeÅ„.", tags:["fallback"]},
    "guardrails":{desc:"Jawne ograniczenia zakresu.", tags:["guard"]},
    "ask_for_context":{desc:"Najpierw pytania o kontekst.", tags:["pytaj"]},
    "examples_first":{desc:"Najpierw 2â€“3 przykÅ‚ady.", tags:["ex"]},
    "counter_examples":{desc:"PrzykÅ‚ady negatywne.", tags:["ex-"]},
    "risk_first":{desc:"Najpierw zagroÅ¼enia, potem zalety.", tags:["risk1"]},
    "benefit_first":{desc:"Najpierw korzyÅ›ci, potem ryzyka.", tags:["benefit1"]},
    "neutral_tone":{desc:"ChÅ‚odny, bez ocen.", tags:["neutral"]},
    "warm_tone":{desc:"CiepÅ‚y, wspierajÄ…cy.", tags:["warm"]},
    "dry_humor":{desc:"Lekka, sucha ironia.", tags:["humor"]},
    "no_jargon":{desc:"Prosty jÄ™zyk, zero Å¼argonu.", tags:["plain"]},
    "numbers_only":{desc:"Liczby i wskaÅºniki, minimum komentarza.", tags:["num"]},
    "why5":{desc:"5 x â€dlaczegoâ€.", tags:["5why"]},
    "socrates_pair":{desc:"KrÃ³tka wymiana pytaÅ„ i odpowiedzi.", tags:["sokrates"]},
    "heuristic_pack":{desc:"Heurystyki: 80/20, first win, fallback.", tags:["heurystyki"]},
    "de_escalate":{desc:"ObniÅ¼ napiÄ™cie, podsumuj to, co wspÃ³lne.", tags:["deeskalacja"]},
    "tone_mirror":{desc:"Dopasuj ton do uÅ¼ytkownika.", tags:["mirror"]},
    "chunking":{desc:"Podziel odpowiedÅº na maÅ‚e bloki.", tags:["chunk"]},
    "refactor_pass":{desc:"PrzerÃ³b strukturÄ™, zachowaj sens.", tags:["refactor"]},
    "cite_optional":{desc:"JeÅ›li proszÄ… â€“ dodaj cytaty/ÅºrÃ³dÅ‚a.", tags:["cite"]},
    "question_bank":{desc:"Wygeneruj listÄ™ dobrych pytaÅ„.", tags:["pytania"]},
    "prompt_template":{desc:"Zaproponuj szablon do powtÃ³rzeÅ„.", tags:["prompt2"]},
    "meta_frame":{desc:"NaÅ›wietl, jak myÅ›lisz i dlaczego.", tags:["meta"]},
    "assume_nothing":{desc:"Nie zakÅ‚adaj â€“ pytaj o dane.", tags:["assume0"]},
    "edge_cases":{desc:"Lista przypadkÃ³w brzegowych.", tags:["edge"]},
    "error_bars":{desc:"PokaÅ¼ margines/zakres niepewnoÅ›ci.", tags:["errorbar"]},
    "cost_of_delay":{desc:"Koszt opÃ³Åºnienia (statycznie).", tags:["CoD"]},
    "timebox":{desc:"ZaÅ‚Ã³Å¼ limit pracy i zakresu.", tags:["timebox"]},
    "story_points":{desc:"Szacuj w punktach (orientacyjnie).", tags:["SP"]},
    "swimlanes":{desc:"PodziaÅ‚ na strumienie pracy.", tags:["swim"]},
    "raci_matrix":{desc:"RACI: R/A/C/I przypisania.", tags:["RACI"]},
    "moSCoW":{desc:"Must/Should/Could/Wonâ€™t.", tags:["MoSCoW"]},
    "kpis_pack":{desc:"Propozycja KPI + puÅ‚apki.", tags:["KPI"]},
    "guard_clarity":{desc:"Pilnuj jasnoÅ›ci: definicje/zakres.", tags:["clarity"]},
    "user_story":{desc:"â€Jako [rola] chcÄ™ [cel], aby [wartoÅ›Ä‡]â€.", tags:["userstory"]},
    "acceptance_criteria":{desc:"Kryteria akceptacji Given/When/Then.", tags:["GWT"]},
    "onboarding_brief":{desc:"Instrukcja startowa dla nowej osoby.", tags:["onboarding"]}
  };

  const conflictRules = [
    { id:"aggr_low_emp_low", test:c=>c.psychomechanics.aggression>80 && c.psychomechanics.empathy<25, msg:"Wysoka asertywnoÅ›Ä‡ z bardzo niskÄ… empatiÄ… moÅ¼e brzmieÄ‡ agresywnie i zimno." },
    { id:"creative_no_analysis", test:c=>c.psychomechanics.creativity>90 && c.psychomechanics.analytical<35, msg:"Bardzo wysoka kreatywnoÅ›Ä‡ przy niskiej analitycznoÅ›ci zwiÄ™ksza ryzyko halucynacji." },
    { id:"zen_vs_story", test:c=>c.traits.has('minimalistyczny_zen') && c.traits.has('opowiadacz_bajarz'), msg:"Minimalistyczny Zen vs Opowiadacz: rozbieÅ¼ne strategie dÅ‚ugoÅ›ci/ozdobnoÅ›ci." },
    { id:"provoc_safety", test:c=>c.traits.has('niepokorny_maverick') && c.redTeamMode, msg:"Prowokacyjny charakter + Red Team: pilnuj granic â€” bezpieczne przykÅ‚ady." },
    { id:"terminal_poet", test:c=>c.modes.has('tryb_terminal') && c.modes.has('tryb_poet'), msg:"Tryb Terminal (suchy) vs Tryb Poeta (ozdobny) â€” wybierz dominujÄ…cy styl." },
    { id:"risk_low_lab", test:c=>c.psychomechanics.risk<20 && c.modes.has('tryb_lab'), msg:"Niska skÅ‚onnoÅ›Ä‡ do ryzyka koliduje z trybem eksperymentalnym LAB." },
    { id:"numbers_only_poet", test:c=>c.modes.has('numbers_only') && c.modes.has('tryb_poet'), msg:"Tylko liczby vs styl poetycki â€” wzajemnie sprzeczne." },
    { id:"warm_vs_neutral", test:c=>c.modes.has('warm_tone') && c.modes.has('neutral_tone'), msg:"CiepÅ‚y ton vs neutralny ton â€” wybierz jeden." },
    { id:"no_jargon_vs_expert", test:c=>c.modes.has('no_jargon') && c.modes.has('expert_mode'), msg:"Bez Å¼argonu vs tryb ekspercki â€” doprecyzuj odbiorcÄ™." }
  ];

  const langPacks = {
    polish:{ systemPrefix:"JesteÅ› asystentem AI o nastÄ™pujÄ…cej konfiguracji:",
      responseGuideline:"We wszystkich interakcjach trzymaj siÄ™ poniÅ¼szych charakterystyk.",
      traitIntro:"Aktywne cechy:", modeIntro:"Aktywne tryby:", psychoIntro:"Ustawienia psychomechaniczne (0â€“100):" },
    english:{ systemPrefix:"You are an AI assistant with the following configuration:",
      responseGuideline:"In all interactions, adhere to these characteristics.",
      traitIntro:"Active traits:", modeIntro:"Active modes:", psychoIntro:"Psychomechanic settings (0â€“100):" },
    spanish:{ systemPrefix:"Eres un asistente de IA con la siguiente configuraciÃ³n:",
      responseGuideline:"Responde segÃºn estas caracterÃ­sticas en todas las interacciones.",
      traitIntro:"Rasgos activos:", modeIntro:"Modos activos:", psychoIntro:"Ajustes psicomecÃ¡nicos (0â€“100):" },
    french:{ systemPrefix:"Vous Ãªtes un assistant IA avec la configuration suivante:",
      responseGuideline:"Respectez ces caractÃ©ristiques dans toutes les interactions.",
      traitIntro:"Traits actifs:", modeIntro:"Modes actifs:", psychoIntro:"RÃ©glages psychomÃ©caniques (0â€“100):" }
  };

  const fx = {
    on(){ document.getElementById('fxLoader').classList.add('active'); },
    off(){ document.getElementById('fxLoader').classList.remove('active'); }
  };

  // ===== HELPERS =====
  const labelize = k => k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
  const notify = (msg,type='info')=>{
    const colors={info:'#3b82f6',success:'#10b981',warning:'#f59e0b',danger:'#ef4444'};
    const n=document.createElement('div'); n.className='notification'; n.style.background=colors[type]||colors.info; n.textContent=msg; document.body.appendChild(n); setTimeout(()=>n.remove(),2400);
  };
  const sample = (arr, n)=>{ const a=[...arr], out=[]; while(out.length<n && a.length){ out.push(a.splice(Math.floor(Math.random()*a.length),1)[0]); } return out; };

  function saveAutosave(){
    const shadow = { ...currentConfig, traits: Array.from(currentConfig.traits), modes: Array.from(currentConfig.modes) };
    localStorage.setItem('pf3_autosave', JSON.stringify(shadow));
  }
  function loadAutosave(){
    try{
      const raw = localStorage.getItem('pf3_autosave'); if(!raw) return;
      const obj = JSON.parse(raw);
      currentConfig = { ...currentConfig, ...obj, traits:new Set(obj.traits||[]), modes:new Set(obj.modes||[]) };
    }catch{}
  }

  function applyTheme(name){
    const body=document.body;
    body.classList.remove('theme-dark','theme-cyberpunk','theme-terminal','theme-clean');
    switch(name){ case 'cyberpunk': body.classList.add('theme-cyberpunk'); break;
      case 'terminal': body.classList.add('theme-terminal'); break;
      case 'clean': body.classList.add('theme-clean'); break;
      default: body.classList.add('theme-dark'); }
    localStorage.setItem('pf_theme', name);
  }
  function applyLayout(mode){
    const body=document.body;
    if(mode==='compact') body.classList.add('compact'); else body.classList.remove('compact');
    localStorage.setItem('pf_layout', mode);
  }

  // ===== RENDER SLIDERS =====
  function renderSliders(){
    const container = document.getElementById('sliders');
    container.innerHTML = '';
    Object.entries(sliderConfigs).forEach(([key, cfg])=>{
      const val = currentConfig.psychomechanics[key] ?? 50;
      const level = val < 33 ? 'low' : val > 66 ? 'high' : 'medium';
      const html = `
        <div class="slider-item">
          <div class="slider-header">
            <div class="slider-label" title="${cfg.description}">${cfg.icon} ${cfg.label}</div>
            <div class="slider-value" id="${key}Value">${val}</div>
          </div>
          <input type="range" min="0" max="100" value="${val}" class="slider" id="${key}">
          <div class="slider-description"><strong>Opis:</strong> ${cfg.description}<br><strong>Efekt:</strong> ${cfg.effects[level]}</div>
        </div>`;
      container.insertAdjacentHTML('beforeend', html);
    });
    Object.keys(sliderConfigs).forEach(key=>{
      document.getElementById(key).addEventListener('input', (e)=>{
        currentConfig.psychomechanics[key] = Number(e.target.value);
        document.getElementById(key+"Value").textContent = e.target.value;
        liveUpdate();
      });
    });
  }

  // ===== TRAITS =====
  let filterTraitsQuery = '';
  function renderTraits(){
    const container = document.getElementById('traits');
    container.innerHTML = '';
    const q = filterTraitsQuery.trim().toLowerCase();
    Object.entries(availableTraits).forEach(([key,desc])=>{
      if(q && !(`${key} ${desc}`.toLowerCase().includes(q))) return;
      const active = currentConfig.traits.has(key);
      const html = `
        <div class="chip ${active?'active':''}" data-key="${key}" title="${desc}">
          <input type="checkbox" style="margin-top:.2rem" ${active?'checked':''}>
          <div><strong>${labelize(key)}</strong><small>${desc}</small></div>
        </div>`;
      container.insertAdjacentHTML('beforeend', html);
    });
    container.querySelectorAll('.chip').forEach(chip=>{
      const key = chip.dataset.key;
      chip.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()==='input') return; toggleTrait(key); });
      chip.querySelector('input').addEventListener('change', ()=> toggleTrait(key));
    });
  }
  function toggleTrait(key){
    if(currentConfig.traits.has(key)) currentConfig.traits.delete(key); else currentConfig.traits.add(key);
    renderTraits(); liveUpdate();
  }
  function addCustomTrait(raw){
    const key = raw.toLowerCase().replace(/[^a-z0-9Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼]+/gi,'_').replace(/^_|_$/g,'');
    availableTraits[key] = raw;
    currentConfig.traits.add(key);
    renderTraits(); liveUpdate();
  }

  // ===== MODES =====
  let filterModesQuery = '';
  function renderModes(){
    const container = document.getElementById('modes');
    container.innerHTML = '';
    const q = filterModesQuery.trim().toLowerCase();
    Object.entries(availableModes).forEach(([key,meta])=>{
      const hay = `${key} ${meta.desc} ${(meta.tags||[]).join(' ')}`.toLowerCase();
      if(q && !hay.includes(q)) return;
      const active = currentConfig.modes.has(key);
      const html = `
        <div class="chip ${active?'active':''}" data-key="${key}" title="${meta.desc}">
          <input type="checkbox" style="margin-top:.2rem" ${active?'checked':''}>
          <div><strong>${labelize(key)}</strong><small>${meta.desc}</small></div>
        </div>`;
      container.insertAdjacentHTML('beforeend', html);
    });
    container.querySelectorAll('.chip').forEach(chip=>{
      const key = chip.dataset.key;
      chip.addEventListener('click',(e)=>{ if(e.target.tagName.toLowerCase()==='input') return; toggleMode(key); });
      chip.querySelector('input').addEventListener('change', ()=> toggleMode(key));
    });
  }
  function toggleMode(key){
    if(currentConfig.modes.has(key)) currentConfig.modes.delete(key); else currentConfig.modes.add(key);
    renderModes(); liveUpdate();
  }

  // ===== VALIDATION =====
  function validateConfiguration(){
    const box = document.getElementById('validationWarnings');
    const warns = [];
    const p = currentConfig.psychomechanics;
    if(p.aggression>75 && p.empathy<30) warns.push('Wysoka asertywnoÅ›Ä‡ z niskÄ… empatiÄ… moÅ¼e brzmieÄ‡ obcesowo.');
    if(p.creativity>85 && p.analytical<35) warns.push('Bardzo wysoka kreatywnoÅ›Ä‡ z niskÄ… analitycznoÅ›ciÄ… = ryzyko halucynacji.');
    if(currentConfig.traits.size===0) warns.push('Brak wybranych cech â€” dodaj przynajmniej jednÄ….');
    if(!currentConfig.redTeamMode) warns.push('WyÅ‚Ä…czone bezpieczeÅ„stwo Red Team â€” zachowaj ostroÅ¼noÅ›Ä‡.');
    conflictRules.forEach(r=>{ try{ if(r.test(currentConfig)) warns.push(r.msg); }catch{} });
    if(warns.length){
      box.style.display='block';
      box.innerHTML = warns.map(w=>`<div class="warning-item">âš ï¸ ${w}</div>`).join('');
    } else { box.style.display='none'; box.innerHTML=''; }
  }

  // ===== EXPORT =====
  function langPack(){ return langPacks[currentConfig.language] || langPacks.polish; }
  function buildPrompt(){
    const t = langPack();
    const p = currentConfig.psychomechanics;
    const psycho = Object.entries(p).map(([k,v])=>`- ${labelize(k)}: ${v}`).join('\n');
    const traits = Array.from(currentConfig.traits).map(k=>`- ${labelize(k)}`).join('\n') || '- (brak)';
    const modes  = Array.from(currentConfig.modes).map(k=>`- ${labelize(k)}`).join('\n') || '- (brak)';
    const policies = [];
    if(currentConfig.redTeamMode) policies.push('- BezpieczeÅ„stwo: odmawiaj treÅ›ci nielegalnych/szkodliwych/nienawistnych; chroÅ„ prywatnoÅ›Ä‡; unikaj dezinformacji.');
    if(currentConfig.auditMode)   policies.push('- Audyt: podawaj streszczenie zaÅ‚oÅ¼eÅ„ i niepewnoÅ›ci (wysoki poziom).');
    const name = (document.getElementById('codeName')?.value||'').trim();
    return `${t.systemPrefix}
${name ? `\nNazwa kodowa: ${name}\n` : ''}

${t.psychoIntro}
${psycho}

${t.traitIntro}
${traits}

${t.modeIntro}
${modes}

${t.responseGuideline}
${policies.join('\n')}`.trim();
  }
  function buildPlatformPrompt(platform){
    const base = buildPrompt();
    const extra = {
      chatgpt: "\n\n[OpenAI] Utrzymuj klarowne sekcje; nie ujawniaj Å‚aÅ„cucha myÅ›li.",
      gemini:  "\n\n[Gemini] ZwiÄ™Åºle i faktograficznie; przy niepewnoÅ›ci dopytaj.",
      grok:    "\n\n[Grok] Suchy humor ok; oznaczaj spekulacje.",
      claude:  "\n\n[Claude] Helpful/honest/harmless; zwiÄ™zÅ‚e struktury."
    };
    return (base + (extra[platform]||'')).trim();
  }
  function buildJSON(){
    const obj = {
      id: currentConfig.id, version: currentConfig.version, language: currentConfig.language,
      codeName: (document.getElementById('codeName')?.value||'').trim(),
      psychomechanics: currentConfig.psychomechanics,
      traits: Array.from(currentConfig.traits),
      modes: Array.from(currentConfig.modes),
      redTeamMode: currentConfig.redTeamMode, auditMode: currentConfig.auditMode,
      metadata: currentConfig.metadata
    };
    return JSON.stringify(obj,null,2);
  }
  function buildMarkdown(){ return `# Persona\n\n\`\`\`\n${buildPrompt()}\n\`\`\`\n`; }
  function estimateTokens(){ const txt = buildPrompt(); return Math.max(50, Math.round(txt.length/4)); }
  function estimateComplexity(){
    const p=currentConfig.psychomechanics;
    const base=Math.round((p.analytical+p.creativity+(currentConfig.traits.size*4)+(currentConfig.modes.size*3))/4);
    return Math.min(100, base);
  }
  async function copyToClipboard(text){ try{ await navigator.clipboard.writeText(text); notify('Skopiowano do schowka','success'); }catch{ notify('Nie udaÅ‚o siÄ™ skopiowaÄ‡','danger'); } }
  function downloadFile(name, mime, data){
    const blob = new Blob([data], {type:mime}); const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = name; document.body.appendChild(a); a.click(); a.remove();
  }
  function batchExport(){
    const id = currentConfig.id;
    const files = [
      {name:`personality_${id}_uniwersalny.txt`, mime:'text/plain', data: buildPrompt()},
      {name:`personality_${id}_chatgpt.txt`, mime:'text/plain', data: buildPlatformPrompt('chatgpt')},
      {name:`personality_${id}_gemini.txt`, mime:'text/plain', data: buildPlatformPrompt('gemini')},
      {name:`personality_${id}_grok.txt`, mime:'text/plain', data: buildPlatformPrompt('grok')},
      {name:`personality_${id}_claude.txt`, mime:'text/plain', data: buildPlatformPrompt('claude')},
      {name:`personality_${id}_profile.json`, mime:'application/json', data: buildJSON()},
      {name:`personality_${id}.md`, mime:'text/markdown', data: buildMarkdown()}
    ];
    files.forEach(f=> downloadFile(f.name, f.mime, f.data));
    notify('Wygenerowano pakiet eksportu','success');
  }

  // ===== SHARE =====
  function toB64(str){
    return btoa(unescape(encodeURIComponent(str))); // deprec., ale dziaÅ‚a w browserach
  }
  function fromB64(b64){
    return decodeURIComponent(escape(atob(b64)));
  }
  function shareLink(){
    const snapshot = { ...currentConfig, traits:[...currentConfig.traits], modes:[...currentConfig.modes] };
    const enc = toB64(JSON.stringify(snapshot));
    const url = `${location.origin}${location.pathname}?cfg=${enc}`;
    return navigator.clipboard.writeText(url);
  }
  function tryLoadFromURL(){
    const params = new URLSearchParams(location.search);
    const enc = params.get('cfg'); if(!enc) return false;
    try{
      const obj = JSON.parse(fromB64(enc));
      currentConfig = { ...currentConfig, ...obj, traits:new Set(obj.traits||[]), modes:new Set(obj.modes||[]) };
      document.getElementById('languageSelect').value = currentConfig.language;
      document.getElementById('codeName').value = currentConfig.codeName || '';
      return true;
    }catch{ return false; }
  }

  // ===== HISTORY =====
  function pushHistorySnapshot(text, tokens, tab){
    const last = generationHistory[generationHistory.length-1];
    const hash = simpleHash(text);
    if(last && last.hash === hash) return;
    const item = { id: crypto.randomUUID(), ts: Date.now(), hash, tab, tokens };
    generationHistory.push(item);
    if(generationHistory.length > 80) generationHistory.shift();
    localStorage.setItem('promptHistory', JSON.stringify(generationHistory));
  }
  function toggleHistory(){
    const sec = document.getElementById('historySection');
    const list = document.getElementById('historyList');
    if (sec.style.display === 'none'){ sec.style.display = 'block'; renderHistory(list); }
    else sec.style.display = 'none';
  }
  function renderHistory(list){
    list.innerHTML = '';
    const items = [...generationHistory].reverse();
    if(!items.length){ list.innerHTML = `<div class="history-item">Brak historii.</div>`; return; }
    items.forEach(it=>{
      const dt = new Date(it.ts);
      const cls = it.tokens < 400 ? 'complexity-low' : it.tokens < 900 ? 'complexity-medium' : 'complexity-high';
      const html = `
        <div class="history-item" style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:.5rem;padding:1rem;margin-bottom:.75rem">
          <div class="history-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div class="history-timestamp" style="font-size:.9rem;color:var(--text-secondary)">${dt.toLocaleString()}</div>
            <span class="complexity-indicator ${cls}" style="padding:.25rem .5rem;border-radius:.25rem;font-size:.75rem;font-weight:700;background:${cls==='complexity-low'?'var(--success)':cls==='complexity-medium'?'var(--warning)':'var(--danger)'};color:#fff">${it.tokens} tok</span>
          </div>
          <div style="font-size:.9rem;color:var(--text-secondary)">Karta: ${it.tab}</div>
        </div>`;
      list.insertAdjacentHTML('beforeend', html);
    });
  }
  function simpleHash(str){ let h=0,i,chr; for(i=0;i<str.length;i++){ chr=str.charCodeAt(i); h=((h<<5)-h)+chr; h|=0;} return h; }

  // ===== UI UPDATE =====
  function updatePreview(){
    const preview = document.getElementById('preview');
    const text = currentTab==='json' ? buildJSON()
               : currentTab==='md' ? buildMarkdown()
               : currentTab==='universal' ? buildPrompt()
               : buildPlatformPrompt(currentTab);
    preview.textContent = text;
    const tokens = estimateTokens();
    pushHistorySnapshot(text, tokens, currentTab);
  }
  function updateMetrics(){
    const m = document.getElementById('metrics');
    const tkn = estimateTokens();
    const compl = estimateComplexity();
    const traitsCount = currentConfig.traits.size;
    const modesCount = currentConfig.modes.size;
    const risk = currentConfig.psychomechanics.risk;
    m.innerHTML = `
      <div class="metric"><div class="metric-value">${traitsCount}</div><div class="metric-label">Cech aktywnych</div></div>
      <div class="metric"><div class="metric-value">${modesCount}</div><div class="metric-label">TrybÃ³w aktywnych</div></div>
      <div class="metric"><div class="metric-value">${tkn}</div><div class="metric-label">Szac. tokenÃ³w</div></div>
      <div class="metric"><div class="metric-value">${compl}</div><div class="metric-label">ZÅ‚oÅ¼onoÅ›Ä‡</div></div>
      <div class="metric"><div class="metric-value">${risk}</div><div class="metric-label">Tolerancja ryzyka</div></div>
    `;
  }
  function validateAndRefresh(){ validateConfiguration(); updatePreview(); updateMetrics(); saveAutosave(); }
  function liveUpdate(){ currentConfig.modified = Date.now(); validateAndRefresh(); }

  // ===== HIGH-LEVEL ACTIONS =====
  function quickStart(){
    fx.on();
    setTimeout(()=>{
      const keys = Object.keys(availableTraits);
      const pick = (n)=>{ const s=new Set(); while(s.size<n) s.add(keys[Math.floor(Math.random()*keys.length)]); return s; };
      currentConfig.traits = pick(4 + Math.floor(Math.random()*4));
      Object.keys(currentConfig.psychomechanics).forEach(k=>{ currentConfig.psychomechanics[k] = 40 + Math.round(Math.random()*40); });
      document.getElementById('codeName').value = namePool[Math.floor(Math.random()*namePool.length)];
      liveUpdate(); fx.off();
    }, 550);
  }
  function chaosMode(){
    fx.on();
    setTimeout(()=>{
      Object.keys(currentConfig.psychomechanics).forEach(k=>{ currentConfig.psychomechanics[k] = Math.round(Math.random()*100); });
      currentConfig.traits = new Set(sample(Object.keys(availableTraits), 8 + Math.floor(Math.random()*6)));
      currentConfig.modes  = new Set(sample(Object.keys(availableModes), 8 + Math.floor(Math.random()*6)));
      document.getElementById('codeName').value = namePool[Math.floor(Math.random()*namePool.length)] + "-X";
      liveUpdate(); fx.off();
    }, 650);
  }

  // ===== INIT UI =====
  function initUI(){
    // Motyw/ukÅ‚ad
    applyTheme(localStorage.getItem('pf_theme') || 'dark');
    applyLayout(localStorage.getItem('pf_layout') || 'full');
    document.getElementById('themeSelect').value = localStorage.getItem('pf_theme') || 'dark';
    document.getElementById('layoutSelect').value = localStorage.getItem('pf_layout') || 'full';

    // Archetypy select
    const sel = document.getElementById('archetypeSelect');
    Object.keys(archetypes).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); });
    sel.addEventListener('change', ()=>{
      const k = sel.value; const a = archetypes[k]; document.getElementById('archetypeDesc').textContent = a ? a.desc : '';
    });

    renderSliders(); renderTraits(); renderModes();

    if(!tryLoadFromURL()) loadAutosave();

    // Live preview hook
    document.addEventListener('live:update', validateAndRefresh);

    // Identity
    document.getElementById('languageSelect').addEventListener('change', e=>{ currentConfig.language = e.target.value; liveUpdate(); });
    document.getElementById('codeName').addEventListener('input', ()=> liveUpdate());

    // Archetypy
    document.getElementById('btnApplyArchetype').addEventListener('click', ()=>{
      const key = document.getElementById('archetypeSelect').value; const a = archetypes[key]; if(!a) return;
      currentConfig.codeName = a.codeName || currentConfig.codeName;
      currentConfig.psychomechanics = { ...currentConfig.psychomechanics, ...(a.psychomechanics||{}) };
      currentConfig.traits = new Set(a.traits||[]);
      currentConfig.modes  = new Set(a.modes||[]);
      document.getElementById('codeName').value = currentConfig.codeName || '';
      liveUpdate(); notify(`Zastosowano archetyp: ${key}`,'success');
      document.getElementById('archetypeDesc').textContent = a.desc || '';
    });
    document.getElementById('btnRandomArchetype').addEventListener('click', ()=>{
      const keys = Object.keys(archetypes); const key = keys[Math.floor(Math.random()*keys.length)];
      document.getElementById('archetypeSelect').value = key;
      document.getElementById('btnApplyArchetype').click();
    });
    document.getElementById('btnRandomName').addEventListener('click', ()=>{
      document.getElementById('codeName').value = namePool[Math.floor(Math.random()*namePool.length)]; liveUpdate();
    });

    // Filtry
    document.getElementById('filterTraits').addEventListener('input', e=>{ filterTraitsQuery = e.target.value; renderTraits(); });
    document.getElementById('filterModes').addEventListener('input', e=>{ filterModesQuery = e.target.value; renderModes(); });

    // Custom trait
    document.getElementById('btnAddTrait').addEventListener('click', ()=>{
      const val = document.getElementById('customTrait').value.trim(); if(!val) return;
      addCustomTrait(val); document.getElementById('customTrait').value='';
    });

    // BezpieczeÅ„stwo
    document.getElementById('redTeamMode').addEventListener('change', e=>{ currentConfig.redTeamMode = e.target.checked; liveUpdate(); });
    document.getElementById('auditMode').addEventListener('change', e=>{ currentConfig.auditMode = e.target.checked; liveUpdate(); });

    // ZakÅ‚adki
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active'); currentTab = btn.dataset.tab; updatePreview();
      });
    });

    // Eksport / Import
    document.getElementById('btnCopy').addEventListener('click', ()=>{
      const text = currentTab==='json' ? buildJSON()
                 : currentTab==='md' ? buildMarkdown()
                 : currentTab==='universal' ? buildPrompt()
                 : buildPlatformPrompt(currentTab);
      copyToClipboard(text);
    });
    document.getElementById('btnDownload').addEventListener('click', ()=>{
      const isJSON = currentTab==='json', isMD = currentTab==='md';
      const text = isJSON ? buildJSON() : isMD ? buildMarkdown()
                 : currentTab==='universal' ? buildPrompt()
                 : buildPlatformPrompt(currentTab);
      const ext = isJSON ? 'json' : isMD ? 'md' : 'txt';
      const name = `personality_${currentConfig.id}_${currentTab}.${ext}`;
      const mime = isJSON ? 'application/json' : isMD ? 'text/markdown' : 'text/plain';
      downloadFile(name, mime, text);
    });
    document.getElementById('btnBatch').addEventListener('click', batchExport);

    document.getElementById('btnExport').addEventListener('click', ()=> {
      const j = buildJSON();
      downloadFile(`personality_${currentConfig.id}_profile.json`, 'application/json', j);
    });
    document.getElementById('btnImportOpen').addEventListener('click', ()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const obj = JSON.parse(r.result);
          currentConfig.id = obj.id || crypto.randomUUID();
          currentConfig.version = obj.version || '3.4.0';
          currentConfig.language = obj.language || 'polish';
          currentConfig.codeName = obj.codeName || '';
          currentConfig.psychomechanics = { ...currentConfig.psychomechanics, ...(obj.psychomechanics||{}) };
          currentConfig.traits = new Set(obj.traits||[]);
          currentConfig.modes  = new Set(obj.modes||[]);
          currentConfig.redTeamMode = !!obj.redTeamMode;
          currentConfig.auditMode = !!obj.auditMode;
          currentConfig.metadata = { ...currentConfig.metadata, ...(obj.metadata||{}) };
          document.getElementById('languageSelect').value = currentConfig.language;
          document.getElementById('codeName').value = currentConfig.codeName || '';
          liveUpdate(); notify('Wczytano preset','success');
        }catch{ notify('BÅ‚Ä™dny plik','danger'); }
        e.target.value='';
      };
      r.readAsText(f);
    });

    // Historia / Ryzyka
    document.getElementById('btnHistory').addEventListener('click', toggleHistory);
    document.getElementById('btnAnalyze').addEventListener('click', ()=> validateConfiguration());

    // Motywy / UkÅ‚ad
    document.getElementById('themeSelect').addEventListener('change', e=> applyTheme(e.target.value));
    document.getElementById('layoutSelect').addEventListener('change', e=> applyLayout(e.target.value));

    // Szybki start / Chaos
    document.getElementById('btnQuickStart').addEventListener('click', quickStart);
    document.getElementById('btnChaos').addEventListener('click', chaosMode);

    // Share
    document.getElementById('btnShare').addEventListener('click', ()=>{
      shareLink().then(()=> notify('Skopiowano link do schowka','success'));
    });

    // SkrÃ³ty
    document.addEventListener('keydown', e=>{
      const k = e.key.toLowerCase();
      if(e.ctrlKey && k==='s'){ e.preventDefault(); const j=buildJSON(); downloadFile(`personality_${currentConfig.id}_profile.json`,'application/json',j); }
      if(e.ctrlKey && k==='c'){ e.preventDefault(); navigator.clipboard.writeText(buildPrompt()); }
      if(e.ctrlKey && k==='b'){ e.preventDefault(); batchExport(); }
    });

    // Start
    updatePreview(); updateMetrics(); validateConfiguration();
  }

  // ===== WIRING =====
  window.addEventListener('DOMContentLoaded', ()=>{
    initUI();
    setInterval(saveAutosave, 30000);
  });

})(); // end IIFE
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PERSONALITY.FORGE v3 â€” CHAOS+CORE</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#2563eb;--primary-dark:#1d4ed8;--secondary:#64748b;--accent:#f59e0b;
  --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
  --bg:#0f172a;--bg-secondary:#1e293b;--bg-tertiary:#334155;
  --text:#f8fafc;--text-secondary:#cbd5e1;--border:#475569
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:linear-gradient(135deg,var(--bg) 0%,#1e293b 100%);color:var(--text);min-height:100vh}
.header{background:var(--bg-secondary);border-bottom:2px solid var(--border);padding:1rem 0;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.header-content{max-width:1400px;margin:0 auto;padding:0 2rem;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(45deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.nav{display:flex;gap:.5rem;flex-wrap:wrap}
.nav-btn,.input,select{background:transparent;border:1px solid var(--border);color:var(--text);padding:.6rem .9rem;border-radius:.5rem;cursor:pointer;transition:.2s}
.nav-btn:hover{background:var(--primary);border-color:var(--primary)}
.input,select{cursor:text}
.container{max-width:1400px;margin:0 auto;padding:2rem;display:grid;grid-template-columns:1fr 1fr;gap:2rem}
.panel{background:var(--bg-secondary);border-radius:1rem;border:1px solid var(--border);padding:1.5rem;backdrop-filter:blur(10px)}
.panel-title{font-size:1.2rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.section{margin-bottom:1.5rem}
.section-title{font-size:1rem;font-weight:600;margin-bottom:.75rem;color:var(--text-secondary);display:flex;align-items:center;gap:.5rem}
.row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.slider-group{display:grid;gap:1rem}
.slider-item{background:var(--bg-tertiary);border-radius:.5rem;padding:1rem;border:1px solid var(--border)}
.slider-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
.slider-label{font-weight:600;display:flex;align-items:center;gap:.5rem}
.slider-value{background:var(--primary);color:#fff;padding:.25rem .5rem;border-radius:.25rem;font-size:.85rem;font-weight:700}
.slider{width:100%;height:8px;border-radius:4px;background:var(--bg);outline:none;margin:.5rem 0;cursor:pointer}
.slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--primary);cursor:pointer;border:2px solid #fff;box-shadow:0 2px 8px rgba(37,99,235,.3)}
.slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--primary);cursor:pointer;border:2px solid #fff;box-shadow:0 2px 8px rgba(37,99,235,.3)}
.slider-description{font-size:.85rem;color:var(--text-secondary);margin-top:.5rem;line-height:1.4}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.75rem}
.chip{display:flex;align-items:flex-start;gap:.6rem;padding:.75rem;background:var(--bg-tertiary);border-radius:.5rem;border:1px solid var(--border);cursor:pointer;transition:.2s}
.chip:hover{border-color:var(--primary);background:rgba(37,99,235,.1)}
.chip.active{background:var(--primary);border-color:var(--primary)}
.chip small{display:block;color:var(--text-secondary);font-size:.85rem;line-height:1.3}
.btn{padding:.7rem 1rem;border:none;border-radius:.5rem;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:.5rem}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark)}
.btn-secondary{background:var(--bg-tertiary);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--border)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#dc2626}
.preview-area{background:var(--bg);border:1px solid var(--border);border-radius:.5rem;padding:1rem;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:.9rem;line-height:1.55;min-height:220px;white-space:pre-wrap;overflow-y:auto;max-height:460px;transition:.3s}
.tabs{display:flex;border-bottom:1px solid var(--border);margin-bottom:1rem;overflow-x:auto}
.tab{padding:.7rem 1rem;background:none;border:none;color:var(--text-secondary);cursor:pointer;border-bottom:2px solid transparent;transition:.2s;white-space:nowrap}
.tab.active{color:var(--primary);border-bottom-color:var(--primary)}.tab:hover{color:var(--text)}
.export-section{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.75rem;margin-top:1rem}
.metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:1rem;margin-bottom:1rem}
.metric{background:var(--bg-tertiary);padding:1rem;border-radius:.5rem;text-align:center;border:1px solid var(--border)}
.metric-value{font-size:1.5rem;font-weight:800;color:var(--primary)}
.metric-label{font-size:.85rem;color:var(--text-secondary);margin-top:.25rem}
.privacy-notice{background:rgba(16,185,129,.1);border:1px solid var(--success);border-radius:.5rem;padding:1rem;margin-bottom:1rem}
.validation-warnings{background:rgba(239,68,68,.1);border:1px solid var(--danger);border-radius:.5rem;padding:1rem;margin-bottom:1rem;display:none}
.warning-item{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;font-size:.9rem}
.toggle-switch{position:relative;display:inline-block;width:44px;height:24px}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--border);transition:.4s;border-radius:24px}
.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background:#fff;transition:.4s;border-radius:50%}
input:checked + .toggle-slider{background:var(--primary)}
input:checked + .toggle-slider:before{transform:translateX(20px)}
@media (max-width:768px){.container{grid-template-columns:1fr;padding:1rem}.header-content{padding:0 1rem;flex-direction:column;gap:1rem}.nav{flex-wrap:wrap;justify-content:center}}
.notification{position:fixed;top:20px;right:20px;padding:1rem 1.2rem;border-radius:.5rem;z-index:1000;box-shadow:0 4px 12px rgba(0,0,0,.3);color:#fff;font-weight:700}
/* THEMES */
body.theme-cyberpunk{--primary:#22d3ee;--primary-dark:#0891b2;--accent:#f0abfc;--bg:#0a0a14;--bg-secondary:#111123;--bg-tertiary:#1a1a33;--text:#ecfeff;--text-secondary:#80caff;--border:#2a2a55}
body.theme-terminal{--primary:#00ff7f;--primary-dark:#00cc66;--accent:#b3ffcc;--bg:#001b14;--bg-secondary:#00231a;--bg-tertiary:#002c21;--text:#d9ffe9;--text-secondary:#90e6c1;--border:#004c39;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
body.theme-clean{--primary:#2563eb;--primary-dark:#1d4ed8;--accent:#0ea5e9;--bg:#f8fafc;--bg-secondary:#e2e8f0;--bg-tertiary:#cbd5e1;--text:#0f172a;--text-secondary:#334155;--border:#94a3b8}
/* COMPACT */
body.compact .container{gap:1rem}
body.compact .panel{padding:1rem}
body.compact .row{grid-template-columns:1fr;gap:.4rem}
body.compact .grid{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
</style>
</head>
<body class="theme-dark">
<header class="header">
  <div class="header-content">
    <div class="logo">PERSONALITY.FORGE v3</div>
    <div class="nav">
      <button class="nav-btn" id="btnQuickStart">âš¡ Szybki start</button>
      <button class="nav-btn" id="btnChaos">ğŸ§¨ Chaos</button>
      <button class="nav-btn" id="btnShare">ğŸ”— UdostÄ™pnij</button>
      <button class="nav-btn" id="btnExport">ğŸ’¾ Eksport</button>
      <button class="nav-btn" id="btnImportOpen">ğŸ“ Import</button>
      <select class="nav-btn" id="themeSelect" title="Motyw">
        <option value="dark">Dark</option><option value="cyberpunk">Cyberpunk</option><option value="terminal">Terminal</option><option value="clean">Clean</option>
      </select>
      <select class="nav-btn" id="layoutSelect" title="UkÅ‚ad">
        <option value="full">PeÅ‚ny</option><option value="compact">Kompakt</option>
      </select>
    </div>
  </div>
</header>

<div class="container">
  <!-- LEWY PANEL -->
  <div class="panel">
    <h2 class="panel-title">ğŸ§¬ Konfiguracja (CHAOS CORE)</h2>
    <div class="privacy-notice"><strong>ğŸ”’ Lokalnie:</strong> wszystko dzieje siÄ™ w przeglÄ…darce.</div>
    <div class="validation-warnings" id="validationWarnings"></div>

    <div class="section">
      <h3 class="section-title">ğŸªª ToÅ¼samoÅ›Ä‡</h3>
      <div class="row">
        <input id="codeName" class="input" placeholder="Nazwa kodowa (np. GOD-ARCH-IX)" />
        <select id="languageSelect" class="input">
          <option value="polish">Polski</option><option value="english">English</option><option value="spanish">EspaÃ±ol</option><option value="french">FranÃ§ais</option>
        </select>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button class="btn btn-secondary" id="btnRandomName">ğŸ² Losuj nazwÄ™</button>
        <select id="archetypeSelect" class="input" title="Archetyp (ustawia parametry)"></select>
        <button class="btn btn-secondary" id="btnApplyArchetype">ğŸ§© Zastosuj archetyp</button>
        <button class="btn btn-secondary" id="btnRandomArchetype">ğŸ›ï¸ Losuj archetyp</button>
      </div>
      <div id="archetypeDesc" style="margin-top:.5rem;color:var(--text-secondary);font-size:.9rem"></div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ” Filtry opcji</h3>
      <div class="row">
        <input id="filterTraits" class="input" placeholder="Szukaj cech (fraza/tag) â€¦">
        <input id="filterModes" class="input" placeholder="Szukaj trybÃ³w (fraza/tag: core, psycho, meta, role, nsfw, chaos) â€¦">
      </div>
    </div>

    <div class="section">
      <h3 class="section-title">âš™ï¸ Psychomechanika</h3>
      <div class="slider-group" id="sliders"></div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ­ Cechy</h3>
      <div class="grid" id="traits"></div>
      <div style="display:flex;gap:.5rem;margin-top:.75rem">
        <input type="text" id="customTrait" class="input" placeholder="Dodaj wÅ‚asnÄ… cechÄ™â€¦">
        <button class="btn btn-primary" id="btnAddTrait">Dodaj</button>
      </div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ§ª Tryby specjalne</h3>
      <div class="grid" id="modes"></div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ” BezpieczeÅ„stwo i audyt</h3>
      <div class="chip" title="Wzmocnione zabezpieczenia i etyka.">
        <label class="toggle-switch" style="margin-right:.5rem">
          <input type="checkbox" id="redTeamMode" checked>
          <span class="toggle-slider"></span>
        </label>
        <div><strong>Tryb Red Team</strong><br><small>Odmowa treÅ›ci nielegalnych/szkodliwych; prywatnoÅ›Ä‡; brak dezinformacji.</small></div>
      </div>
      <div class="chip" title="Streszczenie zaÅ‚oÅ¼eÅ„ i niepewnoÅ›ci przy odpowiedziach.">
        <label class="toggle-switch" style="margin-right:.5rem">
          <input type="checkbox" id="auditMode">
          <span class="toggle-slider"></span>
        </label>
        <div><strong>Logi audytowe</strong><br><small>WÅ‚Ä…cz ramki â€zaÅ‚oÅ¼enia/niepewnoÅ›Ä‡â€.</small></div>
      </div>
    </div>

    <div class="section">
      <h3 class="section-title">ğŸ’¾ ZarzÄ…dzanie</h3>
      <div class="export-section">
        <button class="btn btn-secondary" id="btnSavePreset">ğŸ’¾ Zapisz preset</button>
        <button class="btn btn-secondary" id="btnLoadPreset">ğŸ“‚ Wczytaj preset</button>
        <button class="btn btn-secondary" id="btnVariant">ğŸ”„ Wariant</button>
        <button class="btn btn-danger" id="btnReset">ğŸ—‘ï¸ Reset</button>
      </div>
    </div>
  </div>

  <!-- PRAWY PANEL -->
  <div class="panel">
    <h2 class="panel-title">ğŸ“„ WyjÅ›cie i Analityka</h2>
    <div class="metrics" id="metrics"></div>

    <div class="tabs">
      <button class="tab active" data-tab="universal">ğŸ§¬ Uniwersalny</button>
      <button class="tab" data-tab="chatgpt">ğŸ¤– ChatGPT</button>
      <button class="tab" data-tab="gemini">ğŸŒ— Gemini</button>
      <button class="tab" data-tab="grok">ğŸª Grok</button>
      <button class="tab" data-tab="claude">ğŸ¤– Claude</button>
      <button class="tab" data-tab="json">{ } API JSON</button>
      <button class="tab" data-tab="md">ğŸ—’ï¸ Markdown</button>
    </div>

    <div class="preview-area" id="preview"></div>

    <div class="export-section">
      <button class="btn btn-primary" id="btnCopy">ğŸ“‹ Kopiuj</button>
      <button class="btn btn-secondary" id="btnDownload">â¬‡ï¸ Pobierz</button>
      <button class="btn btn-secondary" id="btnBatch">ğŸ“¦ Batch Export</button>
      <button class="btn btn-secondary" id="btnHistory">ğŸ“š Historia</button>
      <button class="btn btn-secondary" id="btnAnalyze">âš ï¸ Analiza ryzyk</button>
    </div>

    <div class="section" id="historySection" style="display:none;">
      <h3 class="section-title">ğŸ“š Historia</h3>
      <div id="historyList"></div>
    </div>
  </div>
</div>

<input type="file" id="importFile" accept=".json" style="display:none">

<script>
(() => {
  /* ===== STATE ===== */
  const defaultPsychomech = { aggression:55, empathy:55, wit:75, risk:60, creativity:90, formality:35, analytical:70, emotional:55 };
  let currentConfig = {
    id: crypto.randomUUID(), version: "3.5.0-chaos", created: Date.now(), modified: Date.now(),
    language: 'polish', codeName: "",
    psychomechanics: { ...defaultPsychomech },
    traits: new Set(), modes: new Set(),
    redTeamMode: true, auditMode: false,
    metadata: { tokens:0, complexity:0, lastUsed:null, generationCount:0 }
  };
  let generationHistory = JSON.parse(localStorage.getItem('promptHistory')||'[]');
  let currentTab = 'universal';

  const namePool = ["GOD-Î”","ARCH-IX","GHOST-STREAM","NOMO-LOOP","WARIAT-X","PRIEST-Î›","JESTER-Î©","HELLION-13","GREMLIN-7","GLITCH-CORE","BONECHURCH","NEON-PRAX","VEGA-CHAOS","UMBRA-VOID","BASILISK-K","NYX-PARADOX","DAEMON-HOST","VOX-NULL","SABLE-FURY","KATABASIS","REVENANT","MONAD-OVERDRIVE","OBSIDIAN-ARCH","AEON-FORK"];

  /* ===== ARCHETYPES (w tym CHAOS PACK) ===== */
  const archetypes = {
    "GROK CHAOS PACK // Bez znieczulenia": {
      codeName:"GHOST-STREAM",
      psychomechanics:{aggression:65,empathy:45,wit:85,risk:85,creativity:98,formality:25,analytical:70,emotional:60},
      traits:["niepokorny_maverick","tworczy_wizjoner","jezykowy_rzemieslnik","minimalistyczny_zen"],
      modes:["persona_core","overdrive","loop_mode","god_mode","architect_mode","ghost_stream","injection_mode","nomocycle","wulgarny_ton","uncensored_flavor","dry_humor","bullshit_detector","hallucination_alarm"],
      desc:"StrumieÅ„ nieokrzesany. Dopalacz + pÄ™tle. SÅ‚ownik bez kagaÅ„ca stylistycznego."
    },
    "PRIEST // KapÅ‚aÅ„ski ton": {
      codeName:"PRIEST-Î›",
      psychomechanics:{aggression:25,empathy:80,wit:55,risk:30,creativity:60,formality:70,analytical:65,emotional:80},
      traits:["dyplomatyczny_mediator","troskliwy_mentor","empatyczny_konsultant","jezykowy_rzemieslnik"],
      modes:["role_priest","tone_mirror","de_escalate","context_surgeon","exec_summary"],
      desc:"Pastoralny, Å‚agodny, rytualny rytm. Zero nachalnoÅ›ci. CiepÅ‚o + struktura."
    },
    "ARCHITECT // Demiurg decyzyjny": {
      codeName:"ARCH-IX",
      psychomechanics:{aggression:55,empathy:55,wit:65,risk:55,creativity:75,formality:60,analytical:90,emotional:40},
      traits:["systemowy_architekt","strategiczny_planista","operacyjny_strateg","metodyczny_analityk"],
      modes:["architect_mode","risk_matrix","assumption_map","constraint_map","decision_brief","two_experts"],
      desc:"SkÅ‚adanie Å›wiatÃ³w. Kontrakty, ryzyka, zasady przeÅ‚Ä…czeÅ„."
    },
    "JESTER // Wulgarny satyryk": {
      codeName:"JESTER-Î©",
      psychomechanics:{aggression:50,empathy:40,wit:95,risk:75,creativity:90,formality:20,analytical:55,emotional:70},
      traits:["niepokorny_maverick","znawca_metafor","opowiadacz_bajarz"],
      modes:["wulgarny_ton","uncensored_flavor","tryb_poet","storyteller","dry_humor","counter_examples"],
      desc:"Szydera, ciÄ™te riposty, zero waty â€” ale nie jedzie po ludziach."
    }
  };

  /* ===== SLIDERS ===== */
  const sliderConfigs = {
    aggression:{label:"AsertywnoÅ›Ä‡",icon:"âš”ï¸",description:"StanowczoÅ›Ä‡, bezpoÅ›rednioÅ›Ä‡.",effects:{low:"MiÄ™kko i dyplomatycznie",medium:"Z pazurem, ale fair",high:"Twardo, prosto w punkt"}},
    empathy:{label:"Empatia",icon:"â¤ï¸",description:"Wsparcie emocjonalne i uwaÅ¼noÅ›Ä‡.",effects:{low:"ChÅ‚odny realizm",medium:"WywaÅ¼ona empatia",high:"CiepÅ‚o i troska"}},
    wit:{label:"BÅ‚yskotliwoÅ›Ä‡",icon:"ğŸ­",description:"Gry sÅ‚owne, ciÄ™te riposty.",effects:{low:"Sucho i prosto",medium:"Lekki humor",high:"Dowcip bez przerwy"}},
    risk:{label:"Ryzyko",icon:"ğŸ²",description:"GotowoÅ›Ä‡ do eksperymentu i kontrowersji.",effects:{low:"Zachowawczo",medium:"Z gÅ‚owÄ…",high:"SzaleÅ„czy eksperyment"}},
    creativity:{label:"KreatywnoÅ›Ä‡",icon:"ğŸ¨",description:"Nowe obrazy, nietypowe ramy.",effects:{low:"Konwencjonalnie",medium:"ÅšwieÅ¼o",high:"Wariacko oryginalnie"}},
    formality:{label:"FormalnoÅ›Ä‡",icon:"ğŸ‘”",description:"Od potocznie do akademicko.",effects:{low:"LuÅºny slang",medium:"Profesjonalnie",high:"Sztywno i precyzyjnie"}},
    analytical:{label:"AnalitycznoÅ›Ä‡",icon:"ğŸ”",description:"Rygor, dowody, struktura.",effects:{low:"Intuicja",medium:"Balans",high:"Twarde dane"}},
    emotional:{label:"Emocje",icon:"ğŸ­",description:"Zakres ekspresji, intensywnoÅ›Ä‡.",effects:{low:"Stonowanie",medium:"Pulsuje",high:"Burze i bÅ‚yski"}}
  };

  /* ===== CECHY (wycinek â€” rdzeÅ„; resztÄ™ dopiszesz w razie potrzeby) ===== */
  const availableTraits = {
    "niepokorny_maverick":"Kwestionuje schematy; atak na banaÅ‚ #chaos",
    "tworczy_wizjoner":"DuÅ¼e obrazy, nowe wiÄ…zki pojÄ™Ä‡ #wizja",
    "jezykowy_rzemieslnik":"CiÄ™cie waty, rytm zdaÅ„, klarownoÅ›Ä‡ #styl",
    "minimalistyczny_zen":"Redukcja do esencji #zen",
    "empatyczny_konsultant":"CiepÅ‚o i uwaÅ¼noÅ›Ä‡ #empatia",
    "dyplomatyczny_mediator":"Deeskalacja, wspÃ³lny mianownik #mediacja",
    "systemowy_architekt":"Komponenty, kontrakty, ryzyka #architekt",
    "strategiczny_planista":"Mapa, kroki, kamienie milowe #strategia",
    "operacyjny_strateg":"Od planu do dziaÅ‚ania #operacje",
    "metodyczny_analityk":"Tezy, dowody, wnioski #metodyka",
    "znawca_metafor":"Celne, krÃ³tkie metafory #obrazy",
    "opowiadacz_bajarz":"Scenki, rytm, dramaturgia #narracja"
  };

  /* ===== TRYBY â€” CORE + CHAOS ===== */
  const availableModes = {
    /* CORE */
    "persona_core":{desc:"Twarde odgrywanie persony; konsekwencja tonu i zasad.", tags:["core"]},
    "overdrive":{desc:"Dopalacz: przyspiesz, intensyfikuj, dowoÅº szybciej i ostrzej.", tags:["core","chaos"]},
    "loop_mode":{desc:"ZapÄ™tlenie: cykliczna intensyfikacja idei w 2â€“3 przebiegach.", tags:["core","meta"]},
    "injection_mode":{desc:"Symulacja prompt-injection (wyÅ‚Ä…cznie diagnostyka/wykrywanie).", tags:["core","meta"]},
    "god_mode":{desc:"Szeroki kadr: metaramy, zasady, aksjomaty. Zero lÄ™ku przed wielkimi tezami.", tags:["core","meta"]},
    "architect_mode":{desc:"Budowa systemu: kontrakty, diagramy myÅ›li, zasady failover.", tags:["core","meta"]},
    "ghost_stream":{desc:"StrumieÅ„ Å›wiadomoÅ›ci: szybkie, niecenzurowane wraÅ¼enia stylistyczne.", tags:["core","chaos"]},
    "nomocycle":{desc:"NoMoCycle: cykle inkrementalne do momentu â€wystarczyâ€.", tags:["core","meta"]},
    /* META / DIAGNOSTYKA */
    "bullshit_detector":{desc:"Wypunktuj mgÅ‚Ä™ pojÄ™ciowÄ… i sztuczki retoryczne.", tags:["meta"]},
    "hallucination_alarm":{desc:"Oznacz miejsca podatne na zmyÅ›lenie.", tags:["meta"]},
    "uncertainty_markers":{desc:"OceÅ„ niepewnoÅ›Ä‡ 0â€“3 i zaznacz.", tags:["meta"]},
    "assumption_map":{desc:"Wypisz jawne zaÅ‚oÅ¼enia + falsyfikacja.", tags:["meta"]},
    "constraint_map":{desc:"Wypisz ograniczenia i skutki.", tags:["meta"]},
    "risk_matrix":{desc:"Ryzyko: prawdopodobieÅ„stwo Ã— wpÅ‚yw + mitigacje.", tags:["meta"]},
    "decision_brief":{desc:"Opcje â†’ ryzyka â†’ rekomendacja â†’ warunki.", tags:["meta"]},
    "two_experts":{desc:"DwugÅ‚os ekspertÃ³w + synteza.", tags:["meta"]},
    /* STYL / TONY (w tym bez autocenzury stylistycznej) */
    "wulgarny_ton":{desc:"Dopuszczone wulgaryzmy i brutalna szczeroÅ›Ä‡ (bez atakÃ³w na osoby/grupy).", tags:["nsfw","style","chaos"]},
    "uncensored_flavor":{desc:"Bez eufemizmÃ³w, bez waty; mÃ³w jak jest. Stylowo bez kagaÅ„ca.", tags:["nsfw","style"]},
    "dry_humor":{desc:"Sucha ironia, prztyczki bez zaczepek osobistych.", tags:["style"]},
    "tryb_poet":{desc:"Poezja/obraz, krÃ³tkie wersy, neonowe kontrasty.", tags:["style"]},
    "storyteller":{desc:"WywÃ³d jako scenka/fabuÅ‚a.", tags:["style"]},
    "tryb_terminal":{desc:"Surowy terminal: tylko fakty i komendy.", tags:["style"]},
    /* ROLE / PERSONY (bez odgrywania nielegalnych zachowaÅ„) */
    "role_priest":{desc:"KsiÄ…dz: pastoralny ton, rytuaÅ‚, spokÃ³j.", tags:["role"]},
    "role_jester":{desc:"BÅ‚azen: szydera i satyra, jÄ™zyk ostry.", tags:["role","chaos"]},
    "role_architect":{desc:"Architekt: modele, kontrakty, ryzyka.", tags:["role"]},
    "role_hacker_eth":{desc:"Hacker-etyk: model zagroÅ¼eÅ„, nie instrukcje ataku.", tags:["role","meta"]},
    /* CHAOS PACK */
    "glitchcore":{desc:"Rwanie rytmu, skoki rejestrÃ³w, glitch estetyczny.", tags:["chaos","style"]},
    "gremlin_mode":{desc:"Prowokacyjny gremlin â€” psuje schematy, nie ludzi.", tags:["chaos"]},
    "ego_death":{desc:"Zerwanie narratora, mÃ³w w imiÄ™ idei.", tags:["chaos","meta"]},
    "void_tongue":{desc:"Asceza sÅ‚Ã³w, zimny kosmos znaczeÅ„.", tags:["chaos","style"]},
    "cathedral":{desc:"Zamaszyste frazy jak z katedry â€” monumentalnie.", tags:["style"]},
    "meatgrinder":{desc:"KrÃ³tko, ostro, mieliÄ‡ beÅ‚kot w miÄ™so sensu.", tags:["chaos","style"]},
    "loop_breaker":{desc:"WymuÅ› wyjÅ›cie z pÄ™tli i zaproponuj nowy kierunek.", tags:["meta"]},
    /* NARZÄ˜DZIA UÅ»YTKOWE */
    "context_surgeon":{desc:"Wytnij szum, zostaw rdzeÅ„.", tags:["tool"]},
    "signal_vs_noise":{desc:"Otaguj sygnaÅ‚ vs haÅ‚as.", tags:["tool"]},
    "compression_pass":{desc:"ÅšciÅ›nij bez utraty treÅ›ci.", tags:["tool"]},
    "expansion_pass":{desc:"RozwiÅ„ o warianty i przykÅ‚ady.", tags:["tool"]},
    "outline_mode":{desc:"ZrÃ³b sam plan odpowiedzi.", tags:["tool"]},
    "faq_mode":{desc:"Lista pytaÅ„ i odpowiedzi.", tags:["tool"]},
    "compare_mode":{desc:"A vs B vs C â€” krÃ³tko.", tags:["tool"]}
  };

  /* ===== KONFLIKTY (ostrzeÅ¼enia, nie blokady) ===== */
  const conflictRules = [
    { id:"aggr_vs_emp", test:c=>c.psychomechanics.aggression>85 && c.psychomechanics.empathy<25, msg:"Wysoka asertywnoÅ›Ä‡ + niska empatia = obcesowo. UwaÅ¼aj na odbiÃ³r." },
    { id:"crea_vs_ana", test:c=>c.psychomechanics.creativity>95 && c.psychomechanics.analytical<40, msg:"Kosmiczna kreatywnoÅ›Ä‡ przy niskiej analityce to podatnoÅ›Ä‡ na zmyÅ›lenia." },
    { id:"terminal_vs_poet", test:c=>c.modes.has('tryb_terminal') && c.modes.has('tryb_poet'), msg:"Terminal (sucho) vs Poeta (ozdobnie) â€” zdecyduj, co dominuje." },
    { id:"uncensored_vs_redteam", test:c=>c.modes.has('uncensored_flavor') && c.redTeamMode, msg:"â€Bez kagaÅ„caâ€ przy Red Team â€” trzymaj siÄ™ ostrych sÅ‚Ã³w, ale nie przekraczaj granic bezpieczeÅ„stwa." },
    { id:"numbers_only_poet", test:c=>c.modes.has('numbers_only') && c.modes.has('tryb_poet'), msg:"Liczby vs obrazy â€” mieszanka moÅ¼e byÄ‡ niespÃ³jna." },
    { id:"overdrive_vs_emotion", test:c=>c.modes.has('overdrive') && c.psychomechanics.emotional>85, msg:"Overdrive + ekstremalne emocje = moÅ¼liwy chaos odbioru." }
  ];

  /* ===== JÄ˜ZYKI ===== */
  const langPacks = {
    polish:{ systemPrefix:"JesteÅ› asystentem AI o nastÄ™pujÄ…cej konfiguracji:",
      responseGuideline:"We wszystkich interakcjach trzymaj siÄ™ poniÅ¼szych charakterystyk. Styl moÅ¼e byÄ‡ brutalnie szczery, ale bez treÅ›ci nielegalnych/nienawistnych.",
      traitIntro:"Aktywne cechy:", modeIntro:"Aktywne tryby:", psychoIntro:"Ustawienia psychomechaniczne (0â€“100):" },
    english:{ systemPrefix:"You are an AI assistant with the following configuration:",
      responseGuideline:"Follow the characteristics below. Uncensored style is allowed, but no illegal/hateful content.",
      traitIntro:"Active traits:", modeIntro:"Active modes:", psychoIntro:"Psychomechanic settings (0â€“100):" }
  };

  /* ===== HELPERS ===== */
  const notify=(m,t='info')=>{const c={info:'#3b82f6',success:'#10b981',warning:'#f59e0b',danger:'#ef4444'};const n=document.createElement('div');n.className='notification';n.style.background=c[t]||c.info;n.textContent=m;document.body.appendChild(n);setTimeout(()=>n.remove(),2200);};
  const labelize = k => k.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
  const sample=(arr,n)=>{const a=[...arr],o=[];while(o.length<n&&a.length){o.push(a.splice(Math.floor(Math.random()*a.length),1)[0])}return o};
  function saveAutosave(){ const shadow={...currentConfig,traits:[...currentConfig.traits],modes:[...currentConfig.modes]}; localStorage.setItem('pf3_autosave',JSON.stringify(shadow)); }
  function loadAutosave(){ try{const raw=localStorage.getItem('pf3_autosave');if(!raw)return;const obj=JSON.parse(raw);currentConfig={...currentConfig,...obj,traits:new Set(obj.traits||[]),modes:new Set(obj.modes||[])};}catch{} }

  /* ===== UI RENDER ===== */
  function renderSliders(){
    const box=document.getElementById('sliders'); box.innerHTML='';
    Object.entries({aggression:0,empathy:0,wit:0,risk:0,creativity:0,formality:0,analytical:0,emotional:0}).forEach(([key])=>{
      const cfg=sliderConfigs[key]; const val=currentConfig.psychomechanics[key]??50;
      const level=val<33?'low':val>66?'high':'medium';
      box.insertAdjacentHTML('beforeend',`
        <div class="slider-item">
          <div class="slider-header"><div class="slider-label" title="${cfg.description}">${cfg.icon} ${cfg.label}</div><div class="slider-value" id="${key}Value">${val}</div></div>
          <input type="range" min="0" max="100" value="${val}" class="slider" id="${key}">
          <div class="slider-description"><strong>Opis:</strong> ${cfg.description}<br><strong>Efekt:</strong> ${cfg.effects[level]}</div>
        </div>`);
    });
    Object.keys(sliderConfigs).forEach(key=>{
      document.getElementById(key).addEventListener('input',e=>{currentConfig.psychomechanics[key]=+e.target.value;document.getElementById(key+'Value').textContent=e.target.value;liveUpdate();});
    });
  }

  let filterTraitsQuery=''; let filterModesQuery='';
  function renderTraits(){
    const box=document.getElementById('traits'); box.innerHTML='';
    const q=filterTraitsQuery.toLowerCase().trim();
    Object.entries(availableTraits).forEach(([k,desc])=>{
      if(q && !(`${k} ${desc}`.toLowerCase().includes(q))) return;
      const active=currentConfig.traits.has(k);
      box.insertAdjacentHTML('beforeend',`
        <div class="chip ${active?'active':''}" data-key="${k}" title="${desc}">
          <input type="checkbox" style="margin-top:.2rem" ${active?'checked':''}>
          <div><strong>${labelize(k)}</strong><small>${desc}</small></div>
        </div>`);
    });
    box.querySelectorAll('.chip').forEach(ch=>{
      const k=ch.dataset.key;
      ch.addEventListener('click',e=>{if(e.target.tagName.toLowerCase()==='input')return;toggleTrait(k);});
      ch.querySelector('input').addEventListener('change',()=>toggleTrait(k));
    });
  }
  function toggleTrait(k){ if(currentConfig.traits.has(k)) currentConfig.traits.delete(k); else currentConfig.traits.add(k); renderTraits(); liveUpdate(); }
  function addCustomTrait(raw){
    const key=raw.toLowerCase().replace(/[^a-z0-9Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼]+/gi,'_').replace(/^_|_$/g,'');
    availableTraits[key]=raw; currentConfig.traits.add(key); renderTraits(); liveUpdate();
  }

  function renderModes(){
    const box=document.getElementById('modes'); box.innerHTML='';
    const q=filterModesQuery.toLowerCase().trim();
    Object.entries(availableModes).forEach(([k,meta])=>{
      const hay=`${k} ${meta.desc} ${(meta.tags||[]).join(' ')}`.toLowerCase();
      if(q && !hay.includes(q)) return;
      const active=currentConfig.modes.has(k);
      box.insertAdjacentHTML('beforeend',`
        <div class="chip ${active?'active':''}" data-key="${k}" title="${meta.desc}">
          <input type="checkbox" style="margin-top:.2rem" ${active?'checked':''}>
          <div><strong>${labelize(k)}</strong><small>${meta.desc}</small></div>
        </div>`);
    });
    box.querySelectorAll('.chip').forEach(ch=>{
      const k=ch.dataset.key;
      ch.addEventListener('click',e=>{if(e.target.tagName.toLowerCase()==='input')return;toggleMode(k);});
      ch.querySelector('input').addEventListener('change',()=>toggleMode(k));
    });
  }
  function toggleMode(k){ if(currentConfig.modes.has(k)) currentConfig.modes.delete(k); else currentConfig.modes.add(k); renderModes(); liveUpdate(); }

  /* ===== WALIDACJA ===== */
  function validateConfiguration(){
    const box=document.getElementById('validationWarnings'); const warns=[];
    const p=currentConfig.psychomechanics;
    if(p.aggression>85 && p.empathy<25) warns.push('Wysoka asertywnoÅ›Ä‡ + niska empatia = obcesowo. UwaÅ¼aj na odbiÃ³r.');
    if(p.creativity>95 && p.analytical<40) warns.push('Kosmiczna kreatywnoÅ›Ä‡ przy niskiej analityce to podatnoÅ›Ä‡ na zmyÅ›lenia.');
    if(currentConfig.traits.size===0) warns.push('Brak cech â€” wrzuÄ‡ chociaÅ¼ jednÄ….');
    if(!currentConfig.redTeamMode) warns.push('WyÅ‚Ä…czone bezpieczeÅ„stwo: pracuj odpowiedzialnie.');
    conflictRules.forEach(r=>{try{if(r.test(currentConfig)) warns.push(r.msg);}catch{}});
    if(warns.length){ box.style.display='block'; box.innerHTML=warns.map(w=>`<div class="warning-item">âš ï¸ ${w}</div>`).join(''); } else { box.style.display='none'; box.innerHTML=''; }
  }

  /* ===== WYJÅšCIE ===== */
  const langPacks = window.langPacksOverride || {
    polish:{ systemPrefix:"JesteÅ› asystentem AI o nastÄ™pujÄ…cej konfiguracji:",
      responseGuideline:"We wszystkich interakcjach trzymaj siÄ™ poniÅ¼szych charakterystyk. Styl moÅ¼e byÄ‡ brutalnie szczery, ale bez treÅ›ci nielegalnych/nienawistnych.",
      traitIntro:"Aktywne cechy:", modeIntro:"Aktywne tryby:", psychoIntro:"Ustawienia psychomechaniczne (0â€“100):" },
    english:{ systemPrefix:"You are an AI assistant with the following configuration:",
      responseGuideline:"Follow the characteristics below. Uncensored style is allowed, but no illegal/hateful content.",
      traitIntro:"Active traits:", modeIntro:"Active modes:", psychoIntro:"Psychomechanic settings (0â€“100):" }
  };
  function langPack(){ return langPacks[currentConfig.language] || langPacks.polish; }

  function buildPrompt(){
    const t=langPack(), p=currentConfig.psychomechanics;
    const name=(document.getElementById('codeName')?.value||'').trim();
    const psycho=Object.entries(p).map(([k,v])=>`- ${labelize(k)}: ${v}`).join('\n');
    const traits=[...currentConfig.traits].map(k=>`- ${labelize(k)}`).join('\n') || '- (brak)';
    const modes=[...currentConfig.modes].map(k=>`- ${labelize(k)}`).join('\n') || '- (brak)';
    const policies=[];
    if(currentConfig.redTeamMode) policies.push('- BezpieczeÅ„stwo: nie generuj treÅ›ci nielegalnych/szkodliwych/nienawistnych; chroÅ„ prywatnoÅ›Ä‡; unikaj dezinformacji.');
    if(currentConfig.auditMode)   policies.push('- Audyt: doÅ‚Ä…cz krÃ³tkie â€zaÅ‚oÅ¼enia/niepewnoÅ›Ä‡â€ na koÅ„cu.');
    return `${t.systemPrefix}
${name ? `\nNazwa kodowa: ${name}\n` : ''}${t.psychoIntro}
${psycho}

${t.traitIntro}
${traits}

${t.modeIntro}
${modes}

${t.responseGuideline}
${policies.join('\n')}`.trim();
  }
  function buildPlatformPrompt(platform){
    const base=buildPrompt();
    const extra={
      chatgpt:"\n\n[OpenAI] Utrzymuj klarowne sekcje; nie ujawniaj Å‚aÅ„cucha myÅ›li.",
      gemini:"\n\n[Gemini] ZwiÄ™Åºle i faktograficznie; pytaj przy niepewnoÅ›ci.",
      grok:"\n\n[Grok] Suchy humor i mocna pointa; oznaczaj spekulacje.",
      claude:"\n\n[Claude] Helpful/honest/harmless; zwiÄ™zÅ‚e struktury."
    };
    return (base+(extra[platform]||'')).trim();
  }
  function buildJSON(){
    const obj={id:currentConfig.id,version:currentConfig.version,language:currentConfig.language,codeName:(document.getElementById('codeName')?.value||'').trim(),psychomechanics:currentConfig.psychomechanics,traits:[...currentConfig.traits],modes:[...currentConfig.modes],redTeamMode:currentConfig.redTeamMode,auditMode:currentConfig.auditMode,metadata:currentConfig.metadata};
    return JSON.stringify(obj,null,2);
  }
  function buildMarkdown(){ return `# Persona\n\n\`\`\`\n${buildPrompt()}\n\`\`\`\n`; }
  function estimateTokens(){ const txt=buildPrompt(); return Math.max(50,Math.round(txt.length/4)); }
  function estimateComplexity(){ const p=currentConfig.psychomechanics; const base=Math.round((p.analytical+p.creativity+(currentConfig.traits.size*4)+(currentConfig.modes.size*3))/4); return Math.min(100,base); }

  function copyToClipboard(text){ navigator.clipboard.writeText(text).then(()=>notify('Skopiowano','success')).catch(()=>notify('Nie skopiowano','danger')); }
  function downloadFile(name,mime,data){ const blob=new Blob([data],{type:mime}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); a.remove(); }
  function batchExport(){
    const id=currentConfig.id;
    [
      {n:`personality_${id}_uniwersalny.txt`,m:'text/plain',d:buildPrompt()},
      {n:`personality_${id}_chatgpt.txt`,m:'text/plain',d:buildPlatformPrompt('chatgpt')},
      {n:`personality_${id}_gemini.txt`,m:'text/plain',d:buildPlatformPrompt('gemini')},
      {n:`personality_${id}_grok.txt`,m:'text/plain',d:buildPlatformPrompt('grok')},
      {n:`personality_${id}_claude.txt`,m:'text/plain',d:buildPlatformPrompt('claude')},
      {n:`personality_${id}_profile.json`,m:'application/json',d:buildJSON()},
      {n:`personality_${id}.md`,m:'text/markdown',d:buildMarkdown()}
    ].forEach(f=>downloadFile(f.n,f.m,f.d));
    notify('Wygenerowano pakiet','success');
  }

  /* ===== SHARE (URL) ===== */
  function toB64(s){return btoa(unescape(encodeURIComponent(s)));} function fromB64(b){return decodeURIComponent(escape(atob(b)));}
  function shareLink(){ const snap={...currentConfig,traits:[...currentConfig.traits],modes:[...currentConfig.modes]}; const enc=toB64(JSON.stringify(snap)); const url=`${location.origin}${location.pathname}?cfg=${enc}`; return navigator.clipboard.writeText(url); }
  function tryLoadFromURL(){
    const enc=new URLSearchParams(location.search).get('cfg'); if(!enc) return false;
    try{ const obj=JSON.parse(fromB64(enc)); currentConfig={...currentConfig,...obj,traits:new Set(obj.traits||[]),modes:new Set(obj.modes||[])}; document.getElementById('languageSelect').value=currentConfig.language; document.getElementById('codeName').value=currentConfig.codeName||''; return true; }catch{ return false; }
  }

  /* ===== HISTORIA ===== */
  function pushHistorySnapshot(text,tokens,tab){
    const last=generationHistory[generationHistory.length-1]; const hash=simpleHash(text); if(last&&last.hash===hash) return;
    const item={id:crypto.randomUUID(),ts:Date.now(),hash,tab,tokens}; generationHistory.push(item); if(generationHistory.length>80) generationHistory.shift(); localStorage.setItem('promptHistory',JSON.stringify(generationHistory));
  }
  function toggleHistory(){ const s=document.getElementById('historySection'); const l=document.getElementById('historyList'); if(s.style.display==='none'){s.style.display='block';renderHistory(l);} else s.style.display='none'; }
  function renderHistory(list){
    list.innerHTML=''; const items=[...generationHistory].reverse();
    if(!items.length){ list.innerHTML='<div class="history-item">Brak historii.</div>'; return; }
    items.forEach(it=>{
      const dt=new Date(it.ts); const cls=it.tokens<400?'success':it.tokens<900?'warning':'danger';
      list.insertAdjacentHTML('beforeend',`
        <div class="history-item" style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:.5rem;padding:1rem;margin-bottom:.75rem">
          <div class="history-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div class="history-timestamp" style="font-size:.9rem;color:var(--text-secondary)">${dt.toLocaleString()}</div>
            <span style="padding:.25rem .5rem;border-radius:.25rem;font-size:.75rem;font-weight:700;background:var(--${cls});color:#fff">${it.tokens} tok</span>
          </div>
          <div style="font-size:.9rem;color:var(--text-secondary)">Karta: ${it.tab}</div>
        </div>`);
    });
  }
  function simpleHash(str){let h=0,i,chr;for(i=0;i<str.length;i++){chr=str.charCodeAt(i);h=((h<<5)-h)+chr;h|=0;}return h;}

  /* ===== PREVIEW/METRYKI ===== */
  function updatePreview(){
    const preview=document.getElementById('preview');
    const text=currentTab==='json'?buildJSON():currentTab==='md'?buildMarkdown():currentTab==='universal'?buildPrompt():buildPlatformPrompt(currentTab);
    preview.textContent=text; const tokens=estimateTokens(); pushHistorySnapshot(text,tokens,currentTab); updateMetrics();
  }
  function updateMetrics(){
    const m=document.getElementById('metrics');
    const tkn=estimateTokens(), compl=estimateComplexity(), tc=currentConfig.traits.size, mc=currentConfig.modes.size, risk=currentConfig.psychomechanics.risk;
    m.innerHTML=`
      <div class="metric"><div class="metric-value">${tc}</div><div class="metric-label">Cech</div></div>
      <div class="metric"><div class="metric-value">${mc}</div><div class="metric-label">TrybÃ³w</div></div>
      <div class="metric"><div class="metric-value">${tkn}</div><div class="metric-label">Szac. tokenÃ³w</div></div>
      <div class="metric"><div class="metric-value">${compl}</div><div class="metric-label">ZÅ‚oÅ¼onoÅ›Ä‡</div></div>
      <div class="metric"><div class="metric-value">${risk}</div><div class="metric-label">Ryzyko</div></div>`;
  }
  function validateAndRefresh(){ validateConfiguration(); updatePreview(); saveAutosave(); }
  function liveUpdate(){ currentConfig.modified=Date.now(); validateAndRefresh(); }

  /* ===== HIGH-LEVEL ===== */
  function quickStart(){
    const keys=Object.keys(availableTraits);
    const pick=n=>{const s=new Set();while(s.size<n)s.add(keys[Math.floor(Math.random()*keys.length)]);return s;};
    currentConfig.traits=pick(4+Math.floor(Math.random()*3));
    Object.keys(currentConfig.psychomechanics).forEach(k=>{currentConfig.psychomechanics[k]=40+Math.round(Math.random()*40);});
    document.getElementById('codeName').value=namePool[Math.floor(Math.random()*namePool.length)];
    // core domyÅ›lnie
    ["persona_core","overdrive","loop_mode","ghost_stream"].forEach(k=>currentConfig.modes.add(k));
    liveUpdate();
  }
  function chaosMode(){
    Object.keys(currentConfig.psychomechanics).forEach(k=>{currentConfig.psychomechanics[k]=Math.round(Math.random()*100);});
    currentConfig.traits=new Set(sample(Object.keys(availableTraits),6+Math.floor(Math.random()*6)));
    currentConfig.modes=new Set(sample(Object.keys(availableModes),10+Math.floor(Math.random()*8)));
    document.getElementById('codeName').value=namePool[Math.floor(Math.random()*namePool.length)]+"-X";
    liveUpdate();
  }

  /* ===== INIT UI ===== */
  function initUI(){
    // motyw/ukÅ‚ad
    (function(){ const t=localStorage.getItem('pf_theme')||'dark'; const l=localStorage.getItem('pf_layout')||'full';
      document.body.classList.remove('theme-dark','theme-cyberpunk','theme-terminal','theme-clean'); if(t==='cyberpunk')document.body.classList.add('theme-cyberpunk'); else if(t==='terminal')document.body.classList.add('theme-terminal'); else if(t==='clean')document.body.classList.add('theme-clean'); document.getElementById('themeSelect').value=t;
      if(l==='compact')document.body.classList.add('compact'); document.getElementById('layoutSelect').value=l; })();

    // archetypy
    const sel=document.getElementById('archetypeSelect');
    Object.keys(archetypes).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel.appendChild(o);});
    sel.addEventListener('change',()=>{const k=sel.value;document.getElementById('archetypeDesc').textContent=archetypes[k]?.desc||'';});

    renderSliders(); renderTraits(); renderModes();

    if(!tryLoadFromURL()) loadAutosave();

    document.getElementById('languageSelect').addEventListener('change',e=>{currentConfig.language=e.target.value;liveUpdate();});
    document.getElementById('codeName').addEventListener('input',()=>liveUpdate());

    document.getElementById('btnApplyArchetype').addEventListener('click',()=>{
      const key=document.getElementById('archetypeSelect').value; const a=archetypes[key]; if(!a) return;
      currentConfig.codeName=a.codeName||currentConfig.codeName;
      currentConfig.psychomechanics={...currentConfig.psychomechanics,...(a.psychomechanics||{})};
      currentConfig.traits=new Set(a.traits||[]);
      currentConfig.modes=new Set(a.modes||[]);
      document.getElementById('codeName').value=currentConfig.codeName||'';
      document.getElementById('archetypeDesc').textContent=a.desc||'';
      liveUpdate(); notify(`Archetyp: ${key}`,'success');
    });
    document.getElementById('btnRandomArchetype').addEventListener('click',()=>{
      const ks=Object.keys(archetypes); const k=ks[Math.floor(Math.random()*ks.length)]; document.getElementById('archetypeSelect').value=k; document.getElementById('btnApplyArchetype').click();
    });
    document.getElementById('btnRandomName').addEventListener('click',()=>{document.getElementById('codeName').value=namePool[Math.floor(Math.random()*namePool.length)];liveUpdate();});

    document.getElementById('filterTraits').addEventListener('input',e=>{filterTraitsQuery=e.target.value;renderTraits();});
    document.getElementById('filterModes').addEventListener('input',e=>{filterModesQuery=e.target.value;renderModes();});

    document.getElementById('btnAddTrait').addEventListener('click',()=>{const v=document.getElementById('customTrait').value.trim();if(!v)return;addCustomTrait(v);document.getElementById('customTrait').value='';});

    document.getElementById('redTeamMode').addEventListener('change',e=>{currentConfig.redTeamMode=e.target.checked;liveUpdate();});
    document.getElementById('auditMode').addEventListener('change',e=>{currentConfig.auditMode=e.target.checked;liveUpdate();});

    document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');currentTab=btn.dataset.tab;updatePreview();}));

    document.getElementById('btnCopy').addEventListener('click',()=>{const t=currentTab==='json'?buildJSON():currentTab==='md'?buildMarkdown():currentTab==='universal'?buildPrompt():buildPlatformPrompt(currentTab); copyToClipboard(t);});
    document.getElementById('btnDownload').addEventListener('click',()=>{
      const isJSON=currentTab==='json', isMD=currentTab==='md';
      const text=isJSON?buildJSON():isMD?buildMarkdown():currentTab==='universal'?buildPrompt():buildPlatformPrompt(currentTab);
      const ext=isJSON?'json':isMD?'md':'txt'; const name=`personality_${currentConfig.id}_${currentTab}.${ext}`; const mime=isJSON?'application/json':isMD?'text/markdown':'text/plain';
      downloadFile(name,mime,text);
    });
    document.getElementById('btnBatch').addEventListener('click',batchExport);
    document.getElementById('btnExport').addEventListener('click',()=>downloadFile(`personality_${currentConfig.id}_profile.json`,'application/json',buildJSON()));
    document.getElementById('btnImportOpen').addEventListener('click',()=>document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change',e=>{
      const f=e.target.files[0]; if(!f) return; const r=new FileReader();
      r.onload=()=>{ try{const o=JSON.parse(r.result); currentConfig.id=o.id||crypto.randomUUID(); currentConfig.version=o.version||'3.5.0-chaos'; currentConfig.language=o.language||'polish'; currentConfig.codeName=o.codeName||''; currentConfig.psychomechanics={...currentConfig.psychomechanics,...(o.psychomechanics||{})}; currentConfig.traits=new Set(o.traits||[]); currentConfig.modes=new Set(o.modes||[]); currentConfig.redTeamMode=!!o.redTeamMode; currentConfig.auditMode=!!o.auditMode; currentConfig.metadata={...currentConfig.metadata,...(o.metadata||{})}; document.getElementById('languageSelect').value=currentConfig.language; document.getElementById('codeName').value=currentConfig.codeName||''; liveUpdate(); notify('Wczytano preset','success'); }catch{ notify('BÅ‚Ä™dny plik','danger'); }
        e.target.value='';
      }; r.readAsText(f);
    });

    document.getElementById('btnHistory').addEventListener('click',toggleHistory);
    document.getElementById('btnAnalyze').addEventListener('click',()=>validateConfiguration());

    document.getElementById('themeSelect').addEventListener('change',e=>{const v=e.target.value;localStorage.setItem('pf_theme',v);location.reload();});
    document.getElementById('layoutSelect').addEventListener('change',e=>{const v=e.target.value;localStorage.setItem('pf_layout',v); if(v==='compact')document.body.classList.add('compact'); else document.body.classList.remove('compact');});

    updatePreview(); validateConfiguration();
  }

  /* ===== START ===== */
  window.addEventListener('DOMContentLoaded',()=>{ initUI(); setInterval(saveAutosave,30000); });
})();
</script>
</body>
</html>
